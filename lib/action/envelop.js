"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SealedEnvelop = exports.Envelop = void 0;

var _action_pb = _interopRequireDefault(
  require("../../protogen/proto/types/action_pb")
);

var _crypto = require("../crypto/crypto");

var _hash = require("../crypto/hash");

var _types = require("../rpc-method/types");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }
  return obj;
}

class Envelop {
  // optional fields
  constructor(version, nonce, gasLimit, gasPrice) {
    _defineProperty(this, "version", void 0);

    _defineProperty(this, "nonce", void 0);

    _defineProperty(this, "gasLimit", void 0);

    _defineProperty(this, "gasPrice", void 0);

    _defineProperty(this, "transfer", void 0);

    _defineProperty(this, "execution", void 0);

    _defineProperty(this, "startSubChain", void 0);

    _defineProperty(this, "stopSubChain", void 0);

    _defineProperty(this, "putBlock", void 0);

    _defineProperty(this, "createDeposit", void 0);

    _defineProperty(this, "settleDeposit", void 0);

    _defineProperty(this, "createPlumChain", void 0);

    _defineProperty(this, "terminatePlumChain", void 0);

    _defineProperty(this, "plumPutBlock", void 0);

    _defineProperty(this, "plumCreateDeposit", void 0);

    _defineProperty(this, "plumStartExit", void 0);

    _defineProperty(this, "plumChallengeExit", void 0);

    _defineProperty(this, "plumResponseChallengeExit", void 0);

    _defineProperty(this, "plumFinalizeExit", void 0);

    _defineProperty(this, "plumSettleDeposit", void 0);

    _defineProperty(this, "plumTransfer", void 0);

    _defineProperty(this, "depositToRewardingFund", void 0);

    _defineProperty(this, "claimFromRewardingFund", void 0);

    _defineProperty(this, "grantReward", void 0);

    _defineProperty(this, "putPollResult", void 0);

    this.version = version;
    this.nonce = nonce;
    this.gasLimit = gasLimit;
    this.gasPrice = gasPrice;
  } // tslint:disable-next-line:cyclomatic-complexity

  core() {
    const gasLimit = this.gasLimit || "0";
    const gasPrice = this.gasPrice || "0";
    const pbActionCore = new _action_pb.default.ActionCore();
    pbActionCore.setVersion(this.version);
    pbActionCore.setNonce(Number(this.nonce));
    pbActionCore.setGaslimit(Number(gasLimit));
    pbActionCore.setGasprice(gasPrice); // oneof action

    if (this.transfer) {
      pbActionCore.setTransfer((0, _types.toActionTransfer)(this.transfer));
    } else if (this.execution) {
      pbActionCore.setExecution((0, _types.toActionExecution)(this.execution));
    } else if (this.startSubChain) {
      pbActionCore.setStartsubchain(
        (0, _types.toActionStartSubChain)(this.startSubChain)
      );
    } else if (this.stopSubChain) {
      pbActionCore.setStopsubchain(
        (0, _types.toActionStopSubChain)(this.stopSubChain)
      );
    } else if (this.putBlock) {
      pbActionCore.setPutblock((0, _types.toActionPutBlock)(this.putBlock));
    } else if (this.createDeposit) {
      pbActionCore.setCreatedeposit(
        (0, _types.toActionCreateDeposit)(this.createDeposit)
      );
    } else if (this.settleDeposit) {
      pbActionCore.setSettledeposit(
        (0, _types.toActionSettleDeposit)(this.settleDeposit)
      );
    } else if (this.createPlumChain) {
      pbActionCore.setCreateplumchain(
        (0, _types.toActionCreatePlumChain)(this.createPlumChain)
      );
    } else if (this.terminatePlumChain) {
      pbActionCore.setTerminateplumchain(
        (0, _types.toActionTerminatePlumChain)(this.terminatePlumChain)
      );
    } else if (this.plumPutBlock) {
      pbActionCore.setPlumputblock(
        (0, _types.toActionPlumPutBlock)(this.plumPutBlock)
      );
    } else if (this.plumCreateDeposit) {
      pbActionCore.setPlumcreatedeposit(
        (0, _types.toActionPlumCreateDeposit)(this.plumCreateDeposit)
      );
    } else if (this.plumStartExit) {
      pbActionCore.setPlumstartexit(
        (0, _types.toActionPlumStartExit)(this.plumStartExit)
      );
    } else if (this.plumChallengeExit) {
      pbActionCore.setPlumchallengeexit(
        (0, _types.toActionPlumChallengeExit)(this.plumChallengeExit)
      );
    } else if (this.plumResponseChallengeExit) {
      pbActionCore.setPlumresponsechallengeexit(
        (0, _types.toActionPlumResponseChallengeExit)(
          this.plumResponseChallengeExit
        )
      );
    } else if (this.plumFinalizeExit) {
      pbActionCore.setPlumfinalizeexit(
        (0, _types.toActionPlumFinalizeExit)(this.plumFinalizeExit)
      );
    } else if (this.plumSettleDeposit) {
      pbActionCore.setPlumsettledeposit(
        (0, _types.toActionPlumSettleDeposit)(this.plumSettleDeposit)
      );
    } else if (this.plumTransfer) {
      pbActionCore.setPlumtransfer(
        (0, _types.toActionPlumTransfer)(this.plumTransfer)
      );
    } else if (this.depositToRewardingFund) {
      pbActionCore.setDeposittorewardingfund(
        (0, _types.toActionDepositToRewardingFund)(this.depositToRewardingFund)
      );
    } else if (this.claimFromRewardingFund) {
      pbActionCore.setClaimfromrewardingfund(
        (0, _types.toActionClaimFromRewardingFund)(this.claimFromRewardingFund)
      );
    } else if (this.grantReward) {
      pbActionCore.setGrantreward(
        (0, _types.toActionGrantReward)(this.grantReward)
      );
    }

    return pbActionCore;
  }

  bytestream() {
    return this.core().serializeBinary();
  }

  static deserialize(bytes) {
    const pbActionCore = _action_pb.default.ActionCore.deserializeBinary(bytes);

    const envelop = new Envelop(
      pbActionCore.getVersion(),
      String(pbActionCore.getNonce()),
      String(pbActionCore.getGaslimit()),
      pbActionCore.getGasprice()
    );
    envelop.transfer = _types.GetActionsRequest.fromTransfer(
      pbActionCore.getTransfer()
    );
    envelop.execution = _types.GetActionsRequest.fromExecution(
      pbActionCore.getExecution()
    );
    envelop.claimFromRewardingFund = _types.GetActionsRequest.fromClaimFromRewardingFund(
      pbActionCore.getClaimfromrewardingfund()
    ); // TODO(tian): add more fields

    return envelop;
  }
}

exports.Envelop = Envelop;

class SealedEnvelop {
  constructor(act, senderPubKey, signature) {
    _defineProperty(this, "act", void 0);

    _defineProperty(this, "senderPubKey", void 0);

    _defineProperty(this, "signature", void 0);

    this.act = act;
    this.senderPubKey = senderPubKey;
    this.signature = signature;
  }

  bytestream() {
    const pbActionCore = this.act.core();
    const pbAction = new _action_pb.default.Action();
    pbAction.setCore(pbActionCore);
    pbAction.setSenderpubkey(this.senderPubKey);
    pbAction.setSignature(this.signature);
    return pbAction.serializeBinary();
  }

  hash() {
    return Buffer.from((0, _hash.hash256b)(this.bytestream())).toString("hex");
  }

  action() {
    const gasLimit = this.act.gasLimit || "0";
    const gasPrice = this.act.gasPrice || "0";
    return {
      core: {
        version: this.act.version,
        nonce: this.act.nonce,
        gasLimit: gasLimit,
        gasPrice: gasPrice,
        transfer: this.act.transfer,
        execution: this.act.execution,
        startSubChain: this.act.startSubChain,
        stopSubChain: this.act.stopSubChain,
        putBlock: this.act.putBlock,
        createDeposit: this.act.createDeposit,
        settleDeposit: this.act.settleDeposit,
        createPlumChain: this.act.createPlumChain,
        terminatePlumChain: this.act.terminatePlumChain,
        plumPutBlock: this.act.plumPutBlock,
        plumCreateDeposit: this.act.plumCreateDeposit,
        plumStartExit: this.act.plumStartExit,
        plumChallengeExit: this.act.plumChallengeExit,
        plumResponseChallengeExit: this.act.plumResponseChallengeExit,
        plumFinalizeExit: this.act.plumFinalizeExit,
        plumSettleDeposit: this.act.plumSettleDeposit,
        plumTransfer: this.act.plumTransfer,
        depositToRewardingFund: this.act.depositToRewardingFund,
        claimFromRewardingFund: this.act.claimFromRewardingFund,
        grantReward: this.act.grantReward,
        putPollResult: this.act.putPollResult
      },
      senderPubKey: this.senderPubKey,
      signature: this.signature
    };
  }

  static async sign(account, act) {
    const h = (0, _hash.hash256b)(act.bytestream());

    if (account.signer) {
      const signdData = await account.signer.sign(account.address, h);
      return new SealedEnvelop(
        act,
        Buffer.from(signdData.publicKey, "hex"),
        signdData.data
      );
    } else {
      const sign = Buffer.from(
        (0, _crypto.makeSigner)(0)(h.toString("hex"), account.privateKey),
        "hex"
      );
      return new SealedEnvelop(
        act,
        Buffer.from(account.publicKey, "hex"),
        sign
      );
    }
  }
}

exports.SealedEnvelop = SealedEnvelop;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY3Rpb24vZW52ZWxvcC50cyJdLCJuYW1lcyI6WyJFbnZlbG9wIiwiY29uc3RydWN0b3IiLCJ2ZXJzaW9uIiwibm9uY2UiLCJnYXNMaW1pdCIsImdhc1ByaWNlIiwiY29yZSIsInBiQWN0aW9uQ29yZSIsImFjdGlvblBiIiwiQWN0aW9uQ29yZSIsInNldFZlcnNpb24iLCJzZXROb25jZSIsIk51bWJlciIsInNldEdhc2xpbWl0Iiwic2V0R2FzcHJpY2UiLCJ0cmFuc2ZlciIsInNldFRyYW5zZmVyIiwiZXhlY3V0aW9uIiwic2V0RXhlY3V0aW9uIiwic3RhcnRTdWJDaGFpbiIsInNldFN0YXJ0c3ViY2hhaW4iLCJzdG9wU3ViQ2hhaW4iLCJzZXRTdG9wc3ViY2hhaW4iLCJwdXRCbG9jayIsInNldFB1dGJsb2NrIiwiY3JlYXRlRGVwb3NpdCIsInNldENyZWF0ZWRlcG9zaXQiLCJzZXR0bGVEZXBvc2l0Iiwic2V0U2V0dGxlZGVwb3NpdCIsImNyZWF0ZVBsdW1DaGFpbiIsInNldENyZWF0ZXBsdW1jaGFpbiIsInRlcm1pbmF0ZVBsdW1DaGFpbiIsInNldFRlcm1pbmF0ZXBsdW1jaGFpbiIsInBsdW1QdXRCbG9jayIsInNldFBsdW1wdXRibG9jayIsInBsdW1DcmVhdGVEZXBvc2l0Iiwic2V0UGx1bWNyZWF0ZWRlcG9zaXQiLCJwbHVtU3RhcnRFeGl0Iiwic2V0UGx1bXN0YXJ0ZXhpdCIsInBsdW1DaGFsbGVuZ2VFeGl0Iiwic2V0UGx1bWNoYWxsZW5nZWV4aXQiLCJwbHVtUmVzcG9uc2VDaGFsbGVuZ2VFeGl0Iiwic2V0UGx1bXJlc3BvbnNlY2hhbGxlbmdlZXhpdCIsInBsdW1GaW5hbGl6ZUV4aXQiLCJzZXRQbHVtZmluYWxpemVleGl0IiwicGx1bVNldHRsZURlcG9zaXQiLCJzZXRQbHVtc2V0dGxlZGVwb3NpdCIsInBsdW1UcmFuc2ZlciIsInNldFBsdW10cmFuc2ZlciIsImRlcG9zaXRUb1Jld2FyZGluZ0Z1bmQiLCJzZXREZXBvc2l0dG9yZXdhcmRpbmdmdW5kIiwiY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCIsInNldENsYWltZnJvbXJld2FyZGluZ2Z1bmQiLCJncmFudFJld2FyZCIsInNldEdyYW50cmV3YXJkIiwiYnl0ZXN0cmVhbSIsInNlcmlhbGl6ZUJpbmFyeSIsImRlc2VyaWFsaXplIiwiYnl0ZXMiLCJkZXNlcmlhbGl6ZUJpbmFyeSIsImVudmVsb3AiLCJnZXRWZXJzaW9uIiwiU3RyaW5nIiwiZ2V0Tm9uY2UiLCJnZXRHYXNsaW1pdCIsImdldEdhc3ByaWNlIiwiR2V0QWN0aW9uc1JlcXVlc3QiLCJmcm9tVHJhbnNmZXIiLCJnZXRUcmFuc2ZlciIsImZyb21FeGVjdXRpb24iLCJnZXRFeGVjdXRpb24iLCJmcm9tQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCIsImdldENsYWltZnJvbXJld2FyZGluZ2Z1bmQiLCJTZWFsZWRFbnZlbG9wIiwiYWN0Iiwic2VuZGVyUHViS2V5Iiwic2lnbmF0dXJlIiwicGJBY3Rpb24iLCJBY3Rpb24iLCJzZXRDb3JlIiwic2V0U2VuZGVycHVia2V5Iiwic2V0U2lnbmF0dXJlIiwiaGFzaCIsIkJ1ZmZlciIsImZyb20iLCJ0b1N0cmluZyIsImFjdGlvbiIsInB1dFBvbGxSZXN1bHQiLCJzaWduIiwiYWNjb3VudCIsImgiLCJzaWduZXIiLCJzaWduZERhdGEiLCJhZGRyZXNzIiwicHVibGljS2V5IiwiZGF0YSIsInByaXZhdGVLZXkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFFQTs7QUFDQTs7QUFDQTs7Ozs7O0FBOENPLE1BQU1BLE9BQU4sQ0FBYztBQU1uQjtBQXVCQUMsRUFBQUEsV0FBVyxDQUNUQyxPQURTLEVBRVRDLEtBRlMsRUFHVEMsUUFIUyxFQUlUQyxRQUpTLEVBS1Q7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7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QjtBQUNsQixZQUFNQyxTQUFTLEdBQUcsTUFBTUgsT0FBTyxDQUFDRSxNQUFSLENBQWVILElBQWYsQ0FBb0JDLE9BQU8sQ0FBQ0ksT0FBNUIsRUFBcUNILENBQXJDLENBQXhCO0FBQ0EsYUFBTyxJQUFJakIsYUFBSixDQUNMQyxHQURLLEVBRUxTLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZUSxTQUFTLENBQUNFLFNBQXRCLEVBQWlDLEtBQWpDLENBRkssRUFHTEYsU0FBUyxDQUFDRyxJQUhMLENBQVA7QUFLRCxLQVBELE1BT087QUFDTCxZQUFNUCxJQUFJLEdBQUdMLE1BQU0sQ0FBQ0MsSUFBUCxDQUNYLHdCQUFXLENBQVgsRUFBY00sQ0FBQyxDQUFDTCxRQUFGLENBQVcsS0FBWCxDQUFkLEVBQWlDSSxPQUFPLENBQUNPLFVBQXpDLENBRFcsRUFFWCxLQUZXLENBQWI7QUFJQSxhQUFPLElBQUl2QixhQUFKLENBQ0xDLEdBREssRUFFTFMsTUFBTSxDQUFDQyxJQUFQLENBQVlLLE9BQU8sQ0FBQ0ssU0FBcEIsRUFBK0IsS0FBL0IsQ0FGSyxFQUdMTixJQUhLLENBQVA7QUFLRDtBQUNGOztBQXBGd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYWN0aW9uUGIgZnJvbSBcIi4uLy4uL3Byb3RvZ2VuL3Byb3RvL3R5cGVzL2FjdGlvbl9wYlwiO1xuaW1wb3J0IHsgSUFjY291bnQgfSBmcm9tIFwiLi4vYWNjb3VudC9hY2NvdW50XCI7XG5pbXBvcnQgeyBtYWtlU2lnbmVyIH0gZnJvbSBcIi4uL2NyeXB0by9jcnlwdG9cIjtcbmltcG9ydCB7IGhhc2gyNTZiIH0gZnJvbSBcIi4uL2NyeXB0by9oYXNoXCI7XG5pbXBvcnQge1xuICBHZXRBY3Rpb25zUmVxdWVzdCxcbiAgSUFjdGlvbixcbiAgSUNsYWltRnJvbVJld2FyZGluZ0Z1bmQsXG4gIElDcmVhdGVEZXBvc2l0LFxuICBJQ3JlYXRlUGx1bUNoYWluLFxuICBJRGVwb3NpdFRvUmV3YXJkaW5nRnVuZCxcbiAgSUV4ZWN1dGlvbixcbiAgSUdyYW50UmV3YXJkLFxuICBJUGx1bUNoYWxsZW5nZUV4aXQsXG4gIElQbHVtQ3JlYXRlRGVwb3NpdCxcbiAgSVBsdW1GaW5hbGl6ZUV4aXQsXG4gIElQbHVtUHV0QmxvY2ssXG4gIElQbHVtUmVzcG9uc2VDaGFsbGVuZ2VFeGl0LFxuICBJUGx1bVNldHRsZURlcG9zaXQsXG4gIElQbHVtU3RhcnRFeGl0LFxuICBJUGx1bVRyYW5zZmVyLFxuICBJUHV0QmxvY2ssXG4gIElQdXRQb2xsUmVzdWx0LFxuICBJU2V0dGxlRGVwb3NpdCxcbiAgSVN0YXJ0U3ViQ2hhaW4sXG4gIElTdG9wU3ViQ2hhaW4sXG4gIElUZXJtaW5hdGVQbHVtQ2hhaW4sXG4gIElUcmFuc2ZlcixcbiAgdG9BY3Rpb25DbGFpbUZyb21SZXdhcmRpbmdGdW5kLFxuICB0b0FjdGlvbkNyZWF0ZURlcG9zaXQsXG4gIHRvQWN0aW9uQ3JlYXRlUGx1bUNoYWluLFxuICB0b0FjdGlvbkRlcG9zaXRUb1Jld2FyZGluZ0Z1bmQsXG4gIHRvQWN0aW9uRXhlY3V0aW9uLFxuICB0b0FjdGlvbkdyYW50UmV3YXJkLFxuICB0b0FjdGlvblBsdW1DaGFsbGVuZ2VFeGl0LFxuICB0b0FjdGlvblBsdW1DcmVhdGVEZXBvc2l0LFxuICB0b0FjdGlvblBsdW1GaW5hbGl6ZUV4aXQsXG4gIHRvQWN0aW9uUGx1bVB1dEJsb2NrLFxuICB0b0FjdGlvblBsdW1SZXNwb25zZUNoYWxsZW5nZUV4aXQsXG4gIHRvQWN0aW9uUGx1bVNldHRsZURlcG9zaXQsXG4gIHRvQWN0aW9uUGx1bVN0YXJ0RXhpdCxcbiAgdG9BY3Rpb25QbHVtVHJhbnNmZXIsXG4gIHRvQWN0aW9uUHV0QmxvY2ssXG4gIHRvQWN0aW9uU2V0dGxlRGVwb3NpdCxcbiAgdG9BY3Rpb25TdGFydFN1YkNoYWluLFxuICB0b0FjdGlvblN0b3BTdWJDaGFpbixcbiAgdG9BY3Rpb25UZXJtaW5hdGVQbHVtQ2hhaW4sXG4gIHRvQWN0aW9uVHJhbnNmZXJcbn0gZnJvbSBcIi4uL3JwYy1tZXRob2QvdHlwZXNcIjtcblxuZXhwb3J0IGNsYXNzIEVudmVsb3Age1xuICBwdWJsaWMgdmVyc2lvbjogbnVtYmVyO1xuICBwdWJsaWMgbm9uY2U6IHN0cmluZztcbiAgcHVibGljIGdhc0xpbWl0Pzogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgZ2FzUHJpY2U/OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgLy8gb3B0aW9uYWwgZmllbGRzXG4gIHB1YmxpYyB0cmFuc2Zlcj86IElUcmFuc2ZlciB8IHVuZGVmaW5lZDtcbiAgcHVibGljIGV4ZWN1dGlvbj86IElFeGVjdXRpb24gfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBzdGFydFN1YkNoYWluPzogSVN0YXJ0U3ViQ2hhaW4gfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBzdG9wU3ViQ2hhaW4/OiBJU3RvcFN1YkNoYWluIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgcHV0QmxvY2s/OiBJUHV0QmxvY2sgfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBjcmVhdGVEZXBvc2l0PzogSUNyZWF0ZURlcG9zaXQgfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBzZXR0bGVEZXBvc2l0PzogSVNldHRsZURlcG9zaXQgfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBjcmVhdGVQbHVtQ2hhaW4/OiBJQ3JlYXRlUGx1bUNoYWluIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgdGVybWluYXRlUGx1bUNoYWluPzogSVRlcm1pbmF0ZVBsdW1DaGFpbiB8IHVuZGVmaW5lZDtcbiAgcHVibGljIHBsdW1QdXRCbG9jaz86IElQbHVtUHV0QmxvY2sgfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBwbHVtQ3JlYXRlRGVwb3NpdD86IElQbHVtQ3JlYXRlRGVwb3NpdCB8IHVuZGVmaW5lZDtcbiAgcHVibGljIHBsdW1TdGFydEV4aXQ/OiBJUGx1bVN0YXJ0RXhpdCB8IHVuZGVmaW5lZDtcbiAgcHVibGljIHBsdW1DaGFsbGVuZ2VFeGl0PzogSVBsdW1DaGFsbGVuZ2VFeGl0IHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgcGx1bVJlc3BvbnNlQ2hhbGxlbmdlRXhpdD86IElQbHVtUmVzcG9uc2VDaGFsbGVuZ2VFeGl0IHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgcGx1bUZpbmFsaXplRXhpdD86IElQbHVtRmluYWxpemVFeGl0IHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgcGx1bVNldHRsZURlcG9zaXQ/OiBJUGx1bVNldHRsZURlcG9zaXQgfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBwbHVtVHJhbnNmZXI/OiBJUGx1bVRyYW5zZmVyIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgZGVwb3NpdFRvUmV3YXJkaW5nRnVuZD86IElEZXBvc2l0VG9SZXdhcmRpbmdGdW5kIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZD86IElDbGFpbUZyb21SZXdhcmRpbmdGdW5kIHwgdW5kZWZpbmVkO1xuICBwdWJsaWMgZ3JhbnRSZXdhcmQ/OiBJR3JhbnRSZXdhcmQgfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyBwdXRQb2xsUmVzdWx0PzogSVB1dFBvbGxSZXN1bHQgfCB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgdmVyc2lvbjogbnVtYmVyLFxuICAgIG5vbmNlOiBzdHJpbmcsXG4gICAgZ2FzTGltaXQ/OiBzdHJpbmcsXG4gICAgZ2FzUHJpY2U/OiBzdHJpbmdcbiAgKSB7XG4gICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbjtcbiAgICB0aGlzLm5vbmNlID0gbm9uY2U7XG4gICAgdGhpcy5nYXNMaW1pdCA9IGdhc0xpbWl0O1xuICAgIHRoaXMuZ2FzUHJpY2UgPSBnYXNQcmljZTtcbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpjeWNsb21hdGljLWNvbXBsZXhpdHlcbiAgcHVibGljIGNvcmUoKTogYWN0aW9uUGIuQWN0aW9uQ29yZSB7XG4gICAgY29uc3QgZ2FzTGltaXQgPSB0aGlzLmdhc0xpbWl0IHx8IFwiMFwiO1xuICAgIGNvbnN0IGdhc1ByaWNlID0gdGhpcy5nYXNQcmljZSB8fCBcIjBcIjtcblxuICAgIGNvbnN0IHBiQWN0aW9uQ29yZSA9IG5ldyBhY3Rpb25QYi5BY3Rpb25Db3JlKCk7XG4gICAgcGJBY3Rpb25Db3JlLnNldFZlcnNpb24odGhpcy52ZXJzaW9uKTtcbiAgICBwYkFjdGlvbkNvcmUuc2V0Tm9uY2UoTnVtYmVyKHRoaXMubm9uY2UpKTtcbiAgICBwYkFjdGlvbkNvcmUuc2V0R2FzbGltaXQoTnVtYmVyKGdhc0xpbWl0KSk7XG4gICAgcGJBY3Rpb25Db3JlLnNldEdhc3ByaWNlKGdhc1ByaWNlKTtcblxuICAgIC8vIG9uZW9mIGFjdGlvblxuICAgIGlmICh0aGlzLnRyYW5zZmVyKSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0VHJhbnNmZXIodG9BY3Rpb25UcmFuc2Zlcih0aGlzLnRyYW5zZmVyKSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmV4ZWN1dGlvbikge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldEV4ZWN1dGlvbih0b0FjdGlvbkV4ZWN1dGlvbih0aGlzLmV4ZWN1dGlvbikpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5zdGFydFN1YkNoYWluKSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0U3RhcnRzdWJjaGFpbih0b0FjdGlvblN0YXJ0U3ViQ2hhaW4odGhpcy5zdGFydFN1YkNoYWluKSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnN0b3BTdWJDaGFpbikge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldFN0b3BzdWJjaGFpbih0b0FjdGlvblN0b3BTdWJDaGFpbih0aGlzLnN0b3BTdWJDaGFpbikpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5wdXRCbG9jaykge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldFB1dGJsb2NrKHRvQWN0aW9uUHV0QmxvY2sodGhpcy5wdXRCbG9jaykpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5jcmVhdGVEZXBvc2l0KSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0Q3JlYXRlZGVwb3NpdCh0b0FjdGlvbkNyZWF0ZURlcG9zaXQodGhpcy5jcmVhdGVEZXBvc2l0KSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnNldHRsZURlcG9zaXQpIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRTZXR0bGVkZXBvc2l0KHRvQWN0aW9uU2V0dGxlRGVwb3NpdCh0aGlzLnNldHRsZURlcG9zaXQpKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuY3JlYXRlUGx1bUNoYWluKSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0Q3JlYXRlcGx1bWNoYWluKFxuICAgICAgICB0b0FjdGlvbkNyZWF0ZVBsdW1DaGFpbih0aGlzLmNyZWF0ZVBsdW1DaGFpbilcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnRlcm1pbmF0ZVBsdW1DaGFpbikge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldFRlcm1pbmF0ZXBsdW1jaGFpbihcbiAgICAgICAgdG9BY3Rpb25UZXJtaW5hdGVQbHVtQ2hhaW4odGhpcy50ZXJtaW5hdGVQbHVtQ2hhaW4pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAodGhpcy5wbHVtUHV0QmxvY2spIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRQbHVtcHV0YmxvY2sodG9BY3Rpb25QbHVtUHV0QmxvY2sodGhpcy5wbHVtUHV0QmxvY2spKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucGx1bUNyZWF0ZURlcG9zaXQpIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRQbHVtY3JlYXRlZGVwb3NpdChcbiAgICAgICAgdG9BY3Rpb25QbHVtQ3JlYXRlRGVwb3NpdCh0aGlzLnBsdW1DcmVhdGVEZXBvc2l0KVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucGx1bVN0YXJ0RXhpdCkge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldFBsdW1zdGFydGV4aXQodG9BY3Rpb25QbHVtU3RhcnRFeGl0KHRoaXMucGx1bVN0YXJ0RXhpdCkpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5wbHVtQ2hhbGxlbmdlRXhpdCkge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldFBsdW1jaGFsbGVuZ2VleGl0KFxuICAgICAgICB0b0FjdGlvblBsdW1DaGFsbGVuZ2VFeGl0KHRoaXMucGx1bUNoYWxsZW5nZUV4aXQpXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAodGhpcy5wbHVtUmVzcG9uc2VDaGFsbGVuZ2VFeGl0KSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0UGx1bXJlc3BvbnNlY2hhbGxlbmdlZXhpdChcbiAgICAgICAgdG9BY3Rpb25QbHVtUmVzcG9uc2VDaGFsbGVuZ2VFeGl0KHRoaXMucGx1bVJlc3BvbnNlQ2hhbGxlbmdlRXhpdClcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnBsdW1GaW5hbGl6ZUV4aXQpIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRQbHVtZmluYWxpemVleGl0KFxuICAgICAgICB0b0FjdGlvblBsdW1GaW5hbGl6ZUV4aXQodGhpcy5wbHVtRmluYWxpemVFeGl0KVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucGx1bVNldHRsZURlcG9zaXQpIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXRQbHVtc2V0dGxlZGVwb3NpdChcbiAgICAgICAgdG9BY3Rpb25QbHVtU2V0dGxlRGVwb3NpdCh0aGlzLnBsdW1TZXR0bGVEZXBvc2l0KVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucGx1bVRyYW5zZmVyKSB7XG4gICAgICBwYkFjdGlvbkNvcmUuc2V0UGx1bXRyYW5zZmVyKHRvQWN0aW9uUGx1bVRyYW5zZmVyKHRoaXMucGx1bVRyYW5zZmVyKSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmRlcG9zaXRUb1Jld2FyZGluZ0Z1bmQpIHtcbiAgICAgIHBiQWN0aW9uQ29yZS5zZXREZXBvc2l0dG9yZXdhcmRpbmdmdW5kKFxuICAgICAgICB0b0FjdGlvbkRlcG9zaXRUb1Jld2FyZGluZ0Z1bmQodGhpcy5kZXBvc2l0VG9SZXdhcmRpbmdGdW5kKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCkge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldENsYWltZnJvbXJld2FyZGluZ2Z1bmQoXG4gICAgICAgIHRvQWN0aW9uQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCh0aGlzLmNsYWltRnJvbVJld2FyZGluZ0Z1bmQpXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAodGhpcy5ncmFudFJld2FyZCkge1xuICAgICAgcGJBY3Rpb25Db3JlLnNldEdyYW50cmV3YXJkKHRvQWN0aW9uR3JhbnRSZXdhcmQodGhpcy5ncmFudFJld2FyZCkpO1xuICAgIH1cbiAgICByZXR1cm4gcGJBY3Rpb25Db3JlO1xuICB9XG5cbiAgcHVibGljIGJ5dGVzdHJlYW0oKTogVWludDhBcnJheSB7XG4gICAgcmV0dXJuIHRoaXMuY29yZSgpLnNlcmlhbGl6ZUJpbmFyeSgpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBkZXNlcmlhbGl6ZShieXRlczogVWludDhBcnJheSk6IEVudmVsb3Age1xuICAgIGNvbnN0IHBiQWN0aW9uQ29yZSA9IGFjdGlvblBiLkFjdGlvbkNvcmUuZGVzZXJpYWxpemVCaW5hcnkoYnl0ZXMpO1xuICAgIGNvbnN0IGVudmVsb3AgPSBuZXcgRW52ZWxvcChcbiAgICAgIHBiQWN0aW9uQ29yZS5nZXRWZXJzaW9uKCksXG4gICAgICBTdHJpbmcocGJBY3Rpb25Db3JlLmdldE5vbmNlKCkpLFxuICAgICAgU3RyaW5nKHBiQWN0aW9uQ29yZS5nZXRHYXNsaW1pdCgpKSxcbiAgICAgIHBiQWN0aW9uQ29yZS5nZXRHYXNwcmljZSgpXG4gICAgKTtcbiAgICBlbnZlbG9wLnRyYW5zZmVyID0gR2V0QWN0aW9uc1JlcXVlc3QuZnJvbVRyYW5zZmVyKFxuICAgICAgcGJBY3Rpb25Db3JlLmdldFRyYW5zZmVyKClcbiAgICApO1xuICAgIGVudmVsb3AuZXhlY3V0aW9uID0gR2V0QWN0aW9uc1JlcXVlc3QuZnJvbUV4ZWN1dGlvbihcbiAgICAgIHBiQWN0aW9uQ29yZS5nZXRFeGVjdXRpb24oKVxuICAgICk7XG4gICAgZW52ZWxvcC5jbGFpbUZyb21SZXdhcmRpbmdGdW5kID0gR2V0QWN0aW9uc1JlcXVlc3QuZnJvbUNsYWltRnJvbVJld2FyZGluZ0Z1bmQoXG4gICAgICBwYkFjdGlvbkNvcmUuZ2V0Q2xhaW1mcm9tcmV3YXJkaW5nZnVuZCgpXG4gICAgKTtcbiAgICAvLyBUT0RPKHRpYW4pOiBhZGQgbW9yZSBmaWVsZHNcbiAgICByZXR1cm4gZW52ZWxvcDtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgU2VhbGVkRW52ZWxvcCB7XG4gIHB1YmxpYyBhY3Q6IEVudmVsb3A7XG4gIHB1YmxpYyBzZW5kZXJQdWJLZXk6IEJ1ZmZlcjtcbiAgcHVibGljIHNpZ25hdHVyZTogQnVmZmVyO1xuXG4gIGNvbnN0cnVjdG9yKGFjdDogRW52ZWxvcCwgc2VuZGVyUHViS2V5OiBCdWZmZXIsIHNpZ25hdHVyZTogQnVmZmVyKSB7XG4gICAgdGhpcy5hY3QgPSBhY3Q7XG4gICAgdGhpcy5zZW5kZXJQdWJLZXkgPSBzZW5kZXJQdWJLZXk7XG4gICAgdGhpcy5zaWduYXR1cmUgPSBzaWduYXR1cmU7XG4gIH1cblxuICBwdWJsaWMgYnl0ZXN0cmVhbSgpOiBVaW50OEFycmF5IHtcbiAgICBjb25zdCBwYkFjdGlvbkNvcmUgPSB0aGlzLmFjdC5jb3JlKCk7XG4gICAgY29uc3QgcGJBY3Rpb24gPSBuZXcgYWN0aW9uUGIuQWN0aW9uKCk7XG4gICAgcGJBY3Rpb24uc2V0Q29yZShwYkFjdGlvbkNvcmUpO1xuICAgIHBiQWN0aW9uLnNldFNlbmRlcnB1YmtleSh0aGlzLnNlbmRlclB1YktleSk7XG4gICAgcGJBY3Rpb24uc2V0U2lnbmF0dXJlKHRoaXMuc2lnbmF0dXJlKTtcbiAgICByZXR1cm4gcGJBY3Rpb24uc2VyaWFsaXplQmluYXJ5KCk7XG4gIH1cblxuICBwdWJsaWMgaGFzaCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBCdWZmZXIuZnJvbShoYXNoMjU2Yih0aGlzLmJ5dGVzdHJlYW0oKSkpLnRvU3RyaW5nKFwiaGV4XCIpO1xuICB9XG5cbiAgcHVibGljIGFjdGlvbigpOiBJQWN0aW9uIHtcbiAgICBjb25zdCBnYXNMaW1pdCA9IHRoaXMuYWN0Lmdhc0xpbWl0IHx8IFwiMFwiO1xuICAgIGNvbnN0IGdhc1ByaWNlID0gdGhpcy5hY3QuZ2FzUHJpY2UgfHwgXCIwXCI7XG5cbiAgICByZXR1cm4ge1xuICAgICAgY29yZToge1xuICAgICAgICB2ZXJzaW9uOiB0aGlzLmFjdC52ZXJzaW9uLFxuICAgICAgICBub25jZTogdGhpcy5hY3Qubm9uY2UsXG4gICAgICAgIGdhc0xpbWl0OiBnYXNMaW1pdCxcbiAgICAgICAgZ2FzUHJpY2U6IGdhc1ByaWNlLFxuICAgICAgICB0cmFuc2ZlcjogdGhpcy5hY3QudHJhbnNmZXIsXG4gICAgICAgIGV4ZWN1dGlvbjogdGhpcy5hY3QuZXhlY3V0aW9uLFxuICAgICAgICBzdGFydFN1YkNoYWluOiB0aGlzLmFjdC5zdGFydFN1YkNoYWluLFxuICAgICAgICBzdG9wU3ViQ2hhaW46IHRoaXMuYWN0LnN0b3BTdWJDaGFpbixcbiAgICAgICAgcHV0QmxvY2s6IHRoaXMuYWN0LnB1dEJsb2NrLFxuICAgICAgICBjcmVhdGVEZXBvc2l0OiB0aGlzLmFjdC5jcmVhdGVEZXBvc2l0LFxuICAgICAgICBzZXR0bGVEZXBvc2l0OiB0aGlzLmFjdC5zZXR0bGVEZXBvc2l0LFxuICAgICAgICBjcmVhdGVQbHVtQ2hhaW46IHRoaXMuYWN0LmNyZWF0ZVBsdW1DaGFpbixcbiAgICAgICAgdGVybWluYXRlUGx1bUNoYWluOiB0aGlzLmFjdC50ZXJtaW5hdGVQbHVtQ2hhaW4sXG4gICAgICAgIHBsdW1QdXRCbG9jazogdGhpcy5hY3QucGx1bVB1dEJsb2NrLFxuICAgICAgICBwbHVtQ3JlYXRlRGVwb3NpdDogdGhpcy5hY3QucGx1bUNyZWF0ZURlcG9zaXQsXG4gICAgICAgIHBsdW1TdGFydEV4aXQ6IHRoaXMuYWN0LnBsdW1TdGFydEV4aXQsXG4gICAgICAgIHBsdW1DaGFsbGVuZ2VFeGl0OiB0aGlzLmFjdC5wbHVtQ2hhbGxlbmdlRXhpdCxcbiAgICAgICAgcGx1bVJlc3BvbnNlQ2hhbGxlbmdlRXhpdDogdGhpcy5hY3QucGx1bVJlc3BvbnNlQ2hhbGxlbmdlRXhpdCxcbiAgICAgICAgcGx1bUZpbmFsaXplRXhpdDogdGhpcy5hY3QucGx1bUZpbmFsaXplRXhpdCxcbiAgICAgICAgcGx1bVNldHRsZURlcG9zaXQ6IHRoaXMuYWN0LnBsdW1TZXR0bGVEZXBvc2l0LFxuICAgICAgICBwbHVtVHJhbnNmZXI6IHRoaXMuYWN0LnBsdW1UcmFuc2ZlcixcbiAgICAgICAgZGVwb3NpdFRvUmV3YXJkaW5nRnVuZDogdGhpcy5hY3QuZGVwb3NpdFRvUmV3YXJkaW5nRnVuZCxcbiAgICAgICAgY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZDogdGhpcy5hY3QuY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCxcbiAgICAgICAgZ3JhbnRSZXdhcmQ6IHRoaXMuYWN0LmdyYW50UmV3YXJkLFxuICAgICAgICBwdXRQb2xsUmVzdWx0OiB0aGlzLmFjdC5wdXRQb2xsUmVzdWx0XG4gICAgICB9LFxuICAgICAgc2VuZGVyUHViS2V5OiB0aGlzLnNlbmRlclB1YktleSxcbiAgICAgIHNpZ25hdHVyZTogdGhpcy5zaWduYXR1cmVcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBhc3luYyBzaWduKFxuICAgIGFjY291bnQ6IElBY2NvdW50LFxuICAgIGFjdDogRW52ZWxvcFxuICApOiBQcm9taXNlPFNlYWxlZEVudmVsb3A+IHtcbiAgICBjb25zdCBoID0gaGFzaDI1NmIoYWN0LmJ5dGVzdHJlYW0oKSk7XG4gICAgaWYgKGFjY291bnQuc2lnbmVyKSB7XG4gICAgICBjb25zdCBzaWduZERhdGEgPSBhd2FpdCBhY2NvdW50LnNpZ25lci5zaWduKGFjY291bnQuYWRkcmVzcywgaCk7XG4gICAgICByZXR1cm4gbmV3IFNlYWxlZEVudmVsb3AoXG4gICAgICAgIGFjdCxcbiAgICAgICAgQnVmZmVyLmZyb20oc2lnbmREYXRhLnB1YmxpY0tleSwgXCJoZXhcIiksXG4gICAgICAgIHNpZ25kRGF0YS5kYXRhXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBzaWduID0gQnVmZmVyLmZyb20oXG4gICAgICAgIG1ha2VTaWduZXIoMCkoaC50b1N0cmluZyhcImhleFwiKSwgYWNjb3VudC5wcml2YXRlS2V5KSxcbiAgICAgICAgXCJoZXhcIlxuICAgICAgKTtcbiAgICAgIHJldHVybiBuZXcgU2VhbGVkRW52ZWxvcChcbiAgICAgICAgYWN0LFxuICAgICAgICBCdWZmZXIuZnJvbShhY2NvdW50LnB1YmxpY0tleSwgXCJoZXhcIiksXG4gICAgICAgIHNpZ25cbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXX0=
