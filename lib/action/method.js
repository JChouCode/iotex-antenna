"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ClaimFromRewardingFundMethod = exports.ExecutionMethod = exports.TransferMethod = exports.AbstractMethod = void 0;

var _envelop = require("./envelop");

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }
  return obj;
}

class AbstractMethod {
  constructor(client, account, opts) {
    _defineProperty(this, "client", void 0);

    _defineProperty(this, "account", void 0);

    _defineProperty(this, "signer", void 0);

    this.client = client;
    this.account = account;
    this.signer = opts && opts.signer;
  }

  async baseEnvelop(gasLimit, gasPrice) {
    let nonce = "";

    if (this.account && this.account.address) {
      const meta = await this.client.getAccount({
        address: this.account.address
      });
      nonce = String((meta.accountMeta && meta.accountMeta.pendingNonce) || "");
    }

    return new _envelop.Envelop(1, nonce, gasLimit, gasPrice);
  }

  async signAction(envelop) {
    if (!envelop.gasPrice) {
      const price = await this.client.suggestGasPrice({});
      envelop.gasPrice = String(price.gasPrice);
    }

    if (!envelop.gasLimit) {
      const selp = await _envelop.SealedEnvelop.sign(this.account, envelop);
      const limit = await this.client.estimateGasForAction({
        action: selp.action()
      });
      envelop.gasLimit = limit.gas;
    }

    return _envelop.SealedEnvelop.sign(this.account, envelop);
  }

  async sendAction(envelop) {
    if (this.signer && this.signer.signAndSend) {
      return this.signer.signAndSend(envelop);
    }

    let selp;

    if (this.signer && this.signer.signOnly) {
      selp = await this.signer.signOnly(envelop);
    } else {
      selp = await this.signAction(envelop);
    }

    await this.client.sendAction({
      action: selp.action()
    });
    return selp.hash();
  }
}

exports.AbstractMethod = AbstractMethod;

class TransferMethod extends AbstractMethod {
  constructor(client, account, transfer, opts) {
    super(client, account, opts);

    _defineProperty(this, "transfer", void 0);

    this.transfer = transfer;
  }

  async execute() {
    const envelop = await this.baseEnvelop(
      this.transfer.gasLimit,
      this.transfer.gasPrice
    );
    envelop.transfer = {
      amount: this.transfer.amount,
      recipient: this.transfer.recipient,
      payload: Buffer.from(this.transfer.payload, "hex")
    };
    return this.sendAction(envelop);
  }
}

exports.TransferMethod = TransferMethod;

class ExecutionMethod extends AbstractMethod {
  constructor(client, account, execution, opts) {
    super(client, account, opts);

    _defineProperty(this, "execution", void 0);

    this.execution = execution;
  }

  async execute() {
    const envelop = await this.baseEnvelop(
      this.execution.gasLimit,
      this.execution.gasPrice
    );
    envelop.execution = {
      amount: this.execution.amount,
      contract: this.execution.contract,
      data: this.execution.data
    };
    return this.sendAction(envelop);
  }

  async sign() {
    const envelop = await this.baseEnvelop(
      this.execution.gasLimit,
      this.execution.gasPrice
    );
    envelop.execution = {
      amount: this.execution.amount,
      contract: this.execution.contract,
      data: this.execution.data
    };
    const selp = await this.signAction(envelop);
    return selp.action();
  }
}

exports.ExecutionMethod = ExecutionMethod;

class ClaimFromRewardingFundMethod extends AbstractMethod {
  constructor(client, account, claim, opts) {
    super(client, account, opts);

    _defineProperty(this, "claimFronRewardFund", void 0);

    this.claimFronRewardFund = claim;
  }

  async execute() {
    const envelop = await this.baseEnvelop(
      this.claimFronRewardFund.gasLimit,
      this.claimFronRewardFund.gasPrice
    );
    envelop.claimFromRewardingFund = {
      amount: this.claimFronRewardFund.amount,
      data: this.claimFronRewardFund.data
    };
    return this.sendAction(envelop);
  }

  async sign() {
    const envelop = await this.baseEnvelop(
      this.claimFronRewardFund.gasLimit,
      this.claimFronRewardFund.gasPrice
    );
    envelop.claimFromRewardingFund = {
      amount: this.claimFronRewardFund.amount,
      data: this.claimFronRewardFund.data
    };
    const selp = await this.signAction(envelop);
    return selp.action();
  }
}

exports.ClaimFromRewardingFundMethod = ClaimFromRewardingFundMethod;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY3Rpb24vbWV0aG9kLnRzIl0sIm5hbWVzIjpbIkFic3RyYWN0TWV0aG9kIiwiY29uc3RydWN0b3IiLCJjbGllbnQiLCJhY2NvdW50Iiwib3B0cyIsInNpZ25lciIsImJhc2VFbnZlbG9wIiwiZ2FzTGltaXQiLCJnYXNQcmljZSIsIm5vbmNlIiwiYWRkcmVzcyIsIm1ldGEiLCJnZXRBY2NvdW50IiwiU3RyaW5nIiwiYWNjb3VudE1ldGEiLCJwZW5kaW5nTm9uY2UiLCJFbnZlbG9wIiwic2lnbkFjdGlvbiIsImVudmVsb3AiLCJwcmljZSIsInN1Z2dlc3RHYXNQcmljZSIsInNlbHAiLCJTZWFsZWRFbnZlbG9wIiwic2lnbiIsImxpbWl0IiwiZXN0aW1hdGVHYXNGb3JBY3Rpb24iLCJhY3Rpb24iLCJnYXMiLCJzZW5kQWN0aW9uIiwic2lnbkFuZFNlbmQiLCJzaWduT25seSIsImhhc2giLCJUcmFuc2Zlck1ldGhvZCIsInRyYW5zZmVyIiwiZXhlY3V0ZSIsImFtb3VudCIsInJlY2lwaWVudCIsInBheWxvYWQiLCJCdWZmZXIiLCJmcm9tIiwiRXhlY3V0aW9uTWV0aG9kIiwiZXhlY3V0aW9uIiwiY29udHJhY3QiLCJkYXRhIiwiQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZE1ldGhvZCIsImNsYWltIiwiY2xhaW1Gcm9uUmV3YXJkRnVuZCIsImNsYWltRnJvbVJld2FyZGluZ0Z1bmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7OztBQWFPLE1BQU1BLGNBQU4sQ0FBcUI7QUFLMUJDLEVBQUFBLFdBQVcsQ0FBQ0MsTUFBRCxFQUFxQkMsT0FBckIsRUFBdUNDLElBQXZDLEVBQWtFO0FBQUE7O0FBQUE7O0FBQUE7O0FBQzNFLFNBQUtGLE1BQUwsR0FBY0EsTUFBZDtBQUNBLFNBQUtDLE9BQUwsR0FBZUEsT0FBZjtBQUNBLFNBQUtFLE1BQUwsR0FBY0QsSUFBSSxJQUFJQSxJQUFJLENBQUNDLE1BQTNCO0FBQ0Q7O0FBRUQsUUFBYUMsV0FBYixDQUNF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Q3BCLEtBQUt3QyxtQkFBTCxDQUF5QnZDLFFBREwsRUFFcEIsS0FBS3VDLG1CQUFMLENBQXlCdEMsUUFGTCxDQUF0QjtBQUlBVSxJQUFBQSxPQUFPLENBQUM2QixzQkFBUixHQUFpQztBQUMvQlosTUFBQUEsTUFBTSxFQUFFLEtBQUtXLG1CQUFMLENBQXlCWCxNQURGO0FBRS9CUSxNQUFBQSxJQUFJLEVBQUUsS0FBS0csbUJBQUwsQ0FBeUJIO0FBRkEsS0FBakM7QUFLQSxVQUFNdEIsSUFBSSxHQUFHLE1BQU0sS0FBS0osVUFBTCxDQUFnQkMsT0FBaEIsQ0FBbkI7QUFDQSxXQUFPRyxJQUFJLENBQUNLLE1BQUwsRUFBUDtBQUNEOztBQXRDOEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY2NvdW50IH0gZnJvbSBcIi4uL2FjY291bnQvYWNjb3VudFwiO1xuaW1wb3J0IHsgSUFjdGlvbiwgSVJwY01ldGhvZCB9IGZyb20gXCIuLi9ycGMtbWV0aG9kL3R5cGVzXCI7XG5pbXBvcnQgeyBFbnZlbG9wLCBTZWFsZWRFbnZlbG9wIH0gZnJvbSBcIi4vZW52ZWxvcFwiO1xuaW1wb3J0IHsgQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCwgRXhlY3V0aW9uLCBUcmFuc2ZlciB9IGZyb20gXCIuL3R5cGVzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2lnbmVyUGx1Z2luIHtcbiAgc2lnbkFuZFNlbmQ/KGVudmVsb3A6IEVudmVsb3ApOiBQcm9taXNlPHN0cmluZz47XG5cbiAgc2lnbk9ubHk/KGVudmVsb3A6IEVudmVsb3ApOiBQcm9taXNlPFNlYWxlZEVudmVsb3A+O1xuXG4gIGdldEFjY291bnQ/KGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8QWNjb3VudD47XG59XG5cbmV4cG9ydCB0eXBlIEFic3RyYWN0TWV0aG9kT3B0cyA9IHsgc2lnbmVyPzogU2lnbmVyUGx1Z2luIHwgdW5kZWZpbmVkIH07XG5cbmV4cG9ydCBjbGFzcyBBYnN0cmFjdE1ldGhvZCB7XG4gIHB1YmxpYyBjbGllbnQ6IElScGNNZXRob2Q7XG4gIHB1YmxpYyBhY2NvdW50OiBBY2NvdW50O1xuICBwdWJsaWMgc2lnbmVyPzogU2lnbmVyUGx1Z2luO1xuXG4gIGNvbnN0cnVjdG9yKGNsaWVudDogSVJwY01ldGhvZCwgYWNjb3VudDogQWNjb3VudCwgb3B0cz86IEFic3RyYWN0TWV0aG9kT3B0cykge1xuICAgIHRoaXMuY2xpZW50ID0gY2xpZW50O1xuICAgIHRoaXMuYWNjb3VudCA9IGFjY291bnQ7XG4gICAgdGhpcy5zaWduZXIgPSBvcHRzICYmIG9wdHMuc2lnbmVyO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGJhc2VFbnZlbG9wKFxuICAgIGdhc0xpbWl0Pzogc3RyaW5nLFxuICAgIGdhc1ByaWNlPzogc3RyaW5nXG4gICk6IFByb21pc2U8RW52ZWxvcD4ge1xuICAgIGxldCBub25jZSA9IFwiXCI7XG4gICAgaWYgKHRoaXMuYWNjb3VudCAmJiB0aGlzLmFjY291bnQuYWRkcmVzcykge1xuICAgICAgY29uc3QgbWV0YSA9IGF3YWl0IHRoaXMuY2xpZW50LmdldEFjY291bnQoe1xuICAgICAgICBhZGRyZXNzOiB0aGlzLmFjY291bnQuYWRkcmVzc1xuICAgICAgfSk7XG4gICAgICBub25jZSA9IFN0cmluZygobWV0YS5hY2NvdW50TWV0YSAmJiBtZXRhLmFjY291bnRNZXRhLnBlbmRpbmdOb25jZSkgfHwgXCJcIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBFbnZlbG9wKDEsIG5vbmNlLCBnYXNMaW1pdCwgZ2FzUHJpY2UpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHNpZ25BY3Rpb24oZW52ZWxvcDogRW52ZWxvcCk6IFByb21pc2U8U2VhbGVkRW52ZWxvcD4ge1xuICAgIGlmICghZW52ZWxvcC5nYXNQcmljZSkge1xuICAgICAgY29uc3QgcHJpY2UgPSBhd2FpdCB0aGlzLmNsaWVudC5zdWdnZXN0R2FzUHJpY2Uoe30pO1xuICAgICAgZW52ZWxvcC5nYXNQcmljZSA9IFN0cmluZyhwcmljZS5nYXNQcmljZSk7XG4gICAgfVxuXG4gICAgaWYgKCFlbnZlbG9wLmdhc0xpbWl0KSB7XG4gICAgICBjb25zdCBzZWxwID0gYXdhaXQgU2VhbGVkRW52ZWxvcC5zaWduKHRoaXMuYWNjb3VudCwgZW52ZWxvcCk7XG4gICAgICBjb25zdCBsaW1pdCA9IGF3YWl0IHRoaXMuY2xpZW50LmVzdGltYXRlR2FzRm9yQWN0aW9uKHtcbiAgICAgICAgYWN0aW9uOiBzZWxwLmFjdGlvbigpXG4gICAgICB9KTtcbiAgICAgIGVudmVsb3AuZ2FzTGltaXQgPSBsaW1pdC5nYXM7XG4gICAgfVxuXG4gICAgcmV0dXJuIFNlYWxlZEVudmVsb3Auc2lnbih0aGlzLmFjY291bnQsIGVudmVsb3ApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHNlbmRBY3Rpb24oZW52ZWxvcDogRW52ZWxvcCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgaWYgKHRoaXMuc2lnbmVyICYmIHRoaXMuc2lnbmVyLnNpZ25BbmRTZW5kKSB7XG4gICAgICByZXR1cm4gdGhpcy5zaWduZXIuc2lnbkFuZFNlbmQoZW52ZWxvcCk7XG4gICAgfVxuXG4gICAgbGV0IHNlbHA6IFNlYWxlZEVudmVsb3A7XG4gICAgaWYgKHRoaXMuc2lnbmVyICYmIHRoaXMuc2lnbmVyLnNpZ25Pbmx5KSB7XG4gICAgICBzZWxwID0gYXdhaXQgdGhpcy5zaWduZXIuc2lnbk9ubHkoZW52ZWxvcCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNlbHAgPSBhd2FpdCB0aGlzLnNpZ25BY3Rpb24oZW52ZWxvcCk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5jbGllbnQuc2VuZEFjdGlvbih7XG4gICAgICBhY3Rpb246IHNlbHAuYWN0aW9uKClcbiAgICB9KTtcblxuICAgIHJldHVybiBzZWxwLmhhc2goKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVHJhbnNmZXJNZXRob2QgZXh0ZW5kcyBBYnN0cmFjdE1ldGhvZCB7XG4gIHB1YmxpYyB0cmFuc2ZlcjogVHJhbnNmZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgY2xpZW50OiBJUnBjTWV0aG9kLFxuICAgIGFjY291bnQ6IEFjY291bnQsXG4gICAgdHJhbnNmZXI6IFRyYW5zZmVyLFxuICAgIG9wdHM/OiBBYnN0cmFjdE1ldGhvZE9wdHNcbiAgKSB7XG4gICAgc3VwZXIoY2xpZW50LCBhY2NvdW50LCBvcHRzKTtcbiAgICB0aGlzLnRyYW5zZmVyID0gdHJhbnNmZXI7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZXhlY3V0ZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGVudmVsb3AgPSBhd2FpdCB0aGlzLmJhc2VFbnZlbG9wKFxuICAgICAgdGhpcy50cmFuc2Zlci5nYXNMaW1pdCxcbiAgICAgIHRoaXMudHJhbnNmZXIuZ2FzUHJpY2VcbiAgICApO1xuICAgIGVudmVsb3AudHJhbnNmZXIgPSB7XG4gICAgICBhbW91bnQ6IHRoaXMudHJhbnNmZXIuYW1vdW50LFxuICAgICAgcmVjaXBpZW50OiB0aGlzLnRyYW5zZmVyLnJlY2lwaWVudCxcbiAgICAgIHBheWxvYWQ6IEJ1ZmZlci5mcm9tKHRoaXMudHJhbnNmZXIucGF5bG9hZCwgXCJoZXhcIilcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuc2VuZEFjdGlvbihlbnZlbG9wKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgRXhlY3V0aW9uTWV0aG9kIGV4dGVuZHMgQWJzdHJhY3RNZXRob2Qge1xuICBwdWJsaWMgZXhlY3V0aW9uOiBFeGVjdXRpb247XG5cbiAgY29uc3RydWN0b3IoXG4gICAgY2xpZW50OiBJUnBjTWV0aG9kLFxuICAgIGFjY291bnQ6IEFjY291bnQsXG4gICAgZXhlY3V0aW9uOiBFeGVjdXRpb24sXG4gICAgb3B0cz86IEFic3RyYWN0TWV0aG9kT3B0c1xuICApIHtcbiAgICBzdXBlcihjbGllbnQsIGFjY291bnQsIG9wdHMpO1xuICAgIHRoaXMuZXhlY3V0aW9uID0gZXhlY3V0aW9uO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGV4ZWN1dGUoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBlbnZlbG9wID0gYXdhaXQgdGhpcy5iYXNlRW52ZWxvcChcbiAgICAgIHRoaXMuZXhlY3V0aW9uLmdhc0xpbWl0LFxuICAgICAgdGhpcy5leGVjdXRpb24uZ2FzUHJpY2VcbiAgICApO1xuICAgIGVudmVsb3AuZXhlY3V0aW9uID0ge1xuICAgICAgYW1vdW50OiB0aGlzLmV4ZWN1dGlvbi5hbW91bnQsXG4gICAgICBjb250cmFjdDogdGhpcy5leGVjdXRpb24uY29udHJhY3QsXG4gICAgICBkYXRhOiB0aGlzLmV4ZWN1dGlvbi5kYXRhXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLnNlbmRBY3Rpb24oZW52ZWxvcCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2lnbigpOiBQcm9taXNlPElBY3Rpb24+IHtcbiAgICBjb25zdCBlbnZlbG9wID0gYXdhaXQgdGhpcy5iYXNlRW52ZWxvcChcbiAgICAgIHRoaXMuZXhlY3V0aW9uLmdhc0xpbWl0LFxuICAgICAgdGhpcy5leGVjdXRpb24uZ2FzUHJpY2VcbiAgICApO1xuICAgIGVudmVsb3AuZXhlY3V0aW9uID0ge1xuICAgICAgYW1vdW50OiB0aGlzLmV4ZWN1dGlvbi5hbW91bnQsXG4gICAgICBjb250cmFjdDogdGhpcy5leGVjdXRpb24uY29udHJhY3QsXG4gICAgICBkYXRhOiB0aGlzLmV4ZWN1dGlvbi5kYXRhXG4gICAgfTtcblxuICAgIGNvbnN0IHNlbHAgPSBhd2FpdCB0aGlzLnNpZ25BY3Rpb24oZW52ZWxvcCk7XG4gICAgcmV0dXJuIHNlbHAuYWN0aW9uKCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIENsYWltRnJvbVJld2FyZGluZ0Z1bmRNZXRob2QgZXh0ZW5kcyBBYnN0cmFjdE1ldGhvZCB7XG4gIHB1YmxpYyBjbGFpbUZyb25SZXdhcmRGdW5kOiBDbGFpbUZyb21SZXdhcmRpbmdGdW5kO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGNsaWVudDogSVJwY01ldGhvZCxcbiAgICBhY2NvdW50OiBBY2NvdW50LFxuICAgIGNsYWltOiBDbGFpbUZyb21SZXdhcmRpbmdGdW5kLFxuICAgIG9wdHM/OiBBYnN0cmFjdE1ldGhvZE9wdHNcbiAgKSB7XG4gICAgc3VwZXIoY2xpZW50LCBhY2NvdW50LCBvcHRzKTtcbiAgICB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQgPSBjbGFpbTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBleGVjdXRlKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgZW52ZWxvcCA9IGF3YWl0IHRoaXMuYmFzZUVudmVsb3AoXG4gICAgICB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQuZ2FzTGltaXQsXG4gICAgICB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQuZ2FzUHJpY2VcbiAgICApO1xuICAgIGVudmVsb3AuY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCA9IHtcbiAgICAgIGFtb3VudDogdGhpcy5jbGFpbUZyb25SZXdhcmRGdW5kLmFtb3VudCxcbiAgICAgIGRhdGE6IHRoaXMuY2xhaW1Gcm9uUmV3YXJkRnVuZC5kYXRhXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLnNlbmRBY3Rpb24oZW52ZWxvcCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2lnbigpOiBQcm9taXNlPElBY3Rpb24+IHtcbiAgICBjb25zdCBlbnZlbG9wID0gYXdhaXQgdGhpcy5iYXNlRW52ZWxvcChcbiAgICAgIHRoaXMuY2xhaW1Gcm9uUmV3YXJkRnVuZC5nYXNMaW1pdCxcbiAgICAgIHRoaXMuY2xhaW1Gcm9uUmV3YXJkRnVuZC5nYXNQcmljZVxuICAgICk7XG4gICAgZW52ZWxvcC5jbGFpbUZyb21SZXdhcmRpbmdGdW5kID0ge1xuICAgICAgYW1vdW50OiB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQuYW1vdW50LFxuICAgICAgZGF0YTogdGhpcy5jbGFpbUZyb25SZXdhcmRGdW5kLmRhdGFcbiAgICB9O1xuXG4gICAgY29uc3Qgc2VscCA9IGF3YWl0IHRoaXMuc2lnbkFjdGlvbihlbnZlbG9wKTtcbiAgICByZXR1cm4gc2VscC5hY3Rpb24oKTtcbiAgfVxufVxuIl19
