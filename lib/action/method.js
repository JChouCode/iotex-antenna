"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ClaimFromRewardingFundMethod = exports.ExecutionMethod = exports.TransferMethod = exports.AbstractMethod = void 0;

var _envelop = require("./envelop");

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }
  return obj;
}

class AbstractMethod {
  constructor(client, account, opts) {
    _defineProperty(this, "client", void 0);

    _defineProperty(this, "account", void 0);

    _defineProperty(this, "signer", void 0);

    this.client = client;
    this.account = account;
    this.signer = opts && opts.signer;
  }

  async baseEnvelop(gasLimit, gasPrice) {
    let nonce = "";

    if (this.account && this.account.address) {
      const meta = await this.client.getAccount({
        address: this.account.address
      });
      nonce = String((meta.accountMeta && meta.accountMeta.pendingNonce) || "");
    }

    return new _envelop.Envelop(1, nonce, gasLimit, gasPrice);
  }

  async signAction(envelop) {
    if (!envelop.gasPrice) {
      const price = await this.client.suggestGasPrice({});
      envelop.gasPrice = String(price.gasPrice);
    }

    if (!envelop.gasLimit) {
      const selp = _envelop.SealedEnvelop.sign(
        this.account.privateKey,
        this.account.publicKey,
        envelop
      );

      const limit = await this.client.estimateGasForAction({
        action: selp.action()
      });
      envelop.gasLimit = limit.gas;
    }

    return _envelop.SealedEnvelop.sign(
      this.account.privateKey,
      this.account.publicKey,
      envelop
    );
  }

  async sendAction(envelop) {
    if (this.signer && this.signer.signAndSend) {
      return this.signer.signAndSend(envelop);
    }

    let selp;

    if (this.signer && this.signer.signOnly) {
      selp = await this.signer.signOnly(envelop);
    } else {
      selp = await this.signAction(envelop);
    }

    await this.client.sendAction({
      action: selp.action()
    });
    return selp.hash();
  }
}

exports.AbstractMethod = AbstractMethod;

class TransferMethod extends AbstractMethod {
  constructor(client, account, transfer, opts) {
    super(client, account, opts);

    _defineProperty(this, "transfer", void 0);

    this.transfer = transfer;
  }

  async execute() {
    const envelop = await this.baseEnvelop(
      this.transfer.gasLimit,
      this.transfer.gasPrice
    );
    envelop.transfer = {
      amount: this.transfer.amount,
      recipient: this.transfer.recipient,
      payload: Buffer.from(this.transfer.payload, "hex")
    };
    return this.sendAction(envelop);
  }
}

exports.TransferMethod = TransferMethod;

class ExecutionMethod extends AbstractMethod {
  constructor(client, account, execution, opts) {
    super(client, account, opts);

    _defineProperty(this, "execution", void 0);

    this.execution = execution;
  }

  async execute() {
    const envelop = await this.baseEnvelop(
      this.execution.gasLimit,
      this.execution.gasPrice
    );
    envelop.execution = {
      amount: this.execution.amount,
      contract: this.execution.contract,
      data: this.execution.data
    };
    return this.sendAction(envelop);
  }

  async sign() {
    const envelop = await this.baseEnvelop(
      this.execution.gasLimit,
      this.execution.gasPrice
    );
    envelop.execution = {
      amount: this.execution.amount,
      contract: this.execution.contract,
      data: this.execution.data
    };
    const selp = await this.signAction(envelop);
    return selp.action();
  }
}

exports.ExecutionMethod = ExecutionMethod;

class ClaimFromRewardingFundMethod extends AbstractMethod {
  constructor(client, account, claim, opts) {
    super(client, account, opts);

    _defineProperty(this, "claimFronRewardFund", void 0);

    this.claimFronRewardFund = claim;
  }

  async execute() {
    const envelop = await this.baseEnvelop(
      this.claimFronRewardFund.gasLimit,
      this.claimFronRewardFund.gasPrice
    );
    envelop.claimFromRewardingFund = {
      amount: this.claimFronRewardFund.amount,
      data: this.claimFronRewardFund.data
    };
    return this.sendAction(envelop);
  }

  async sign() {
    const envelop = await this.baseEnvelop(
      this.claimFronRewardFund.gasLimit,
      this.claimFronRewardFund.gasPrice
    );
    envelop.claimFromRewardingFund = {
      amount: this.claimFronRewardFund.amount,
      data: this.claimFronRewardFund.data
    };
    const selp = await this.signAction(envelop);
    return selp.action();
  }
}

exports.ClaimFromRewardingFundMethod = ClaimFromRewardingFundMethod;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY3Rpb24vbWV0aG9kLnRzIl0sIm5hbWVzIjpbIkFic3RyYWN0TWV0aG9kIiwiY29uc3RydWN0b3IiLCJjbGllbnQiLCJhY2NvdW50Iiwib3B0cyIsInNpZ25lciIsImJhc2VFbnZlbG9wIiwiZ2FzTGltaXQiLCJnYXNQcmljZSIsIm5vbmNlIiwiYWRkcmVzcyIsIm1ldGEiLCJnZXRBY2NvdW50IiwiU3RyaW5nIiwiYWNjb3VudE1ldGEiLCJwZW5kaW5nTm9uY2UiLCJFbnZlbG9wIiwic2lnbkFjdGlvbiIsImVudmVsb3AiLCJwcmljZSIsInN1Z2dlc3RHYXNQcmljZSIsInNlbHAiLCJTZWFsZWRFbnZlbG9wIiwic2lnbiIsInByaXZhdGVLZXkiLCJwdWJsaWNLZXkiLCJsaW1pdCIsImVzdGltYXRlR2FzRm9yQWN0aW9uIiwiYWN0aW9uIiwiZ2FzIiwic2VuZEFjdGlvbiIsInNpZ25BbmRTZW5kIiwic2lnbk9ubHkiLCJoYXNoIiwiVHJhbnNmZXJNZXRob2QiLCJ0cmFuc2ZlciIsImV4ZWN1dGUiLCJhbW91bnQiLCJyZWNpcGllbnQiLCJwYXlsb2FkIiwiQnVmZmVyIiwiZnJvbSIsIkV4ZWN1dGlvbk1ldGhvZCIsImV4ZWN1dGlvbiIsImNvbnRyYWN0IiwiZGF0YSIsIkNsYWltRnJvbVJld2FyZGluZ0Z1bmRNZXRob2QiLCJjbGFpbSIsImNsYWltRnJvblJld2FyZEZ1bmQiLCJjbGFpbUZyb21SZXdhcmRpbmdGdW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7Ozs7QUFhTyxNQUFNQSxjQUFOLENBQXFCO0FBSzFCQyxFQUFBQSxXQUFXLENBQUNDLE1BQUQsRUFBcUJDLE9BQXJCLEVBQXVDQyxJQUF2QyxFQUFrRTtBQUFBOztBQUFBOztBQUFBOztBQUMzRSxTQUFLRixNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLQyxPQUFMLEdBQWVBLE9BQWY7QUFDQSxTQUFLRSxNQUFMLEdBQWNELElBQUksSUFBSUEsSUFBSSxDQUFDQyxNQUEzQjtB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QUtmLFVBQUwsQ0FBZ0JaLE9BQWhCLENBQVA7QUFDRDs7QUFFRCxRQUFhSyxJQUFiLEdBQXNDO0FBQ3BDLFVBQU1MLE9BQU8sR0FBRyxNQUFNLEtBQUtaLFdBQUwsQ0FDcEIsS0FBSzBDLG1CQUFMLENBQXlCekMsUUFETCxFQUVwQixLQUFLeUMsbUJBQUwsQ0FBeUJ4QyxRQUZMLENBQXRCO0FBSUFVLElBQUFBLE9BQU8sQ0FBQytCLHNCQUFSLEdBQWlDO0FBQy9CWixNQUFBQSxNQUFNLEVBQUUsS0FBS1csbUJBQUwsQ0FBeUJYLE1BREY7QUFFL0JRLE1BQUFBLElBQUksRUFBRSxLQUFLRyxtQkFBTCxDQUF5Qkg7QUFGQSxLQUFqQztBQUtBLFVBQU14QixJQUFJLEdBQUcsTUFBTSxLQUFLSixVQUFMLENBQWdCQyxPQUFoQixDQUFuQjtBQUNBLFdBQU9HLElBQUksQ0FBQ08sTUFBTCxFQUFQO0FBQ0Q7O0FBdEM4RCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFjY291bnQgfSBmcm9tIFwiLi4vYWNjb3VudC9hY2NvdW50XCI7XG5pbXBvcnQgeyBJQWN0aW9uLCBJUnBjTWV0aG9kIH0gZnJvbSBcIi4uL3JwYy1tZXRob2QvdHlwZXNcIjtcbmltcG9ydCB7IEVudmVsb3AsIFNlYWxlZEVudmVsb3AgfSBmcm9tIFwiLi9lbnZlbG9wXCI7XG5pbXBvcnQgeyBDbGFpbUZyb21SZXdhcmRpbmdGdW5kLCBFeGVjdXRpb24sIFRyYW5zZmVyIH0gZnJvbSBcIi4vdHlwZXNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBTaWduZXJQbHVnaW4ge1xuICBzaWduQW5kU2VuZD8oZW52ZWxvcDogRW52ZWxvcCk6IFByb21pc2U8c3RyaW5nPjtcblxuICBzaWduT25seT8oZW52ZWxvcDogRW52ZWxvcCk6IFByb21pc2U8U2VhbGVkRW52ZWxvcD47XG5cbiAgZ2V0QWNjb3VudD8oYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxBY2NvdW50Pjtcbn1cblxuZXhwb3J0IHR5cGUgQWJzdHJhY3RNZXRob2RPcHRzID0geyBzaWduZXI/OiBTaWduZXJQbHVnaW4gfCB1bmRlZmluZWQgfTtcblxuZXhwb3J0IGNsYXNzIEFic3RyYWN0TWV0aG9kIHtcbiAgcHVibGljIGNsaWVudDogSVJwY01ldGhvZDtcbiAgcHVibGljIGFjY291bnQ6IEFjY291bnQ7XG4gIHB1YmxpYyBzaWduZXI/OiBTaWduZXJQbHVnaW47XG5cbiAgY29uc3RydWN0b3IoY2xpZW50OiBJUnBjTWV0aG9kLCBhY2NvdW50OiBBY2NvdW50LCBvcHRzPzogQWJzdHJhY3RNZXRob2RPcHRzKSB7XG4gICAgdGhpcy5jbGllbnQgPSBjbGllbnQ7XG4gICAgdGhpcy5hY2NvdW50ID0gYWNjb3VudDtcbiAgICB0aGlzLnNpZ25lciA9IG9wdHMgJiYgb3B0cy5zaWduZXI7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYmFzZUVudmVsb3AoXG4gICAgZ2FzTGltaXQ/OiBzdHJpbmcsXG4gICAgZ2FzUHJpY2U/OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxFbnZlbG9wPiB7XG4gICAgbGV0IG5vbmNlID0gXCJcIjtcbiAgICBpZiAodGhpcy5hY2NvdW50ICYmIHRoaXMuYWNjb3VudC5hZGRyZXNzKSB7XG4gICAgICBjb25zdCBtZXRhID0gYXdhaXQgdGhpcy5jbGllbnQuZ2V0QWNjb3VudCh7XG4gICAgICAgIGFkZHJlc3M6IHRoaXMuYWNjb3VudC5hZGRyZXNzXG4gICAgICB9KTtcbiAgICAgIG5vbmNlID0gU3RyaW5nKChtZXRhLmFjY291bnRNZXRhICYmIG1ldGEuYWNjb3VudE1ldGEucGVuZGluZ05vbmNlKSB8fCBcIlwiKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IEVudmVsb3AoMSwgbm9uY2UsIGdhc0xpbWl0LCBnYXNQcmljZSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2lnbkFjdGlvbihlbnZlbG9wOiBFbnZlbG9wKTogUHJvbWlzZTxTZWFsZWRFbnZlbG9wPiB7XG4gICAgaWYgKCFlbnZlbG9wLmdhc1ByaWNlKSB7XG4gICAgICBjb25zdCBwcmljZSA9IGF3YWl0IHRoaXMuY2xpZW50LnN1Z2dlc3RHYXNQcmljZSh7fSk7XG4gICAgICBlbnZlbG9wLmdhc1ByaWNlID0gU3RyaW5nKHByaWNlLmdhc1ByaWNlKTtcbiAgICB9XG5cbiAgICBpZiAoIWVudmVsb3AuZ2FzTGltaXQpIHtcbiAgICAgIGNvbnN0IHNlbHAgPSBTZWFsZWRFbnZlbG9wLnNpZ24oXG4gICAgICAgIHRoaXMuYWNjb3VudC5wcml2YXRlS2V5LFxuICAgICAgICB0aGlzLmFjY291bnQucHVibGljS2V5LFxuICAgICAgICBlbnZlbG9wXG4gICAgICApO1xuICAgICAgY29uc3QgbGltaXQgPSBhd2FpdCB0aGlzLmNsaWVudC5lc3RpbWF0ZUdhc0ZvckFjdGlvbih7XG4gICAgICAgIGFjdGlvbjogc2VscC5hY3Rpb24oKVxuICAgICAgfSk7XG4gICAgICBlbnZlbG9wLmdhc0xpbWl0ID0gbGltaXQuZ2FzO1xuICAgIH1cblxuICAgIHJldHVybiBTZWFsZWRFbnZlbG9wLnNpZ24oXG4gICAgICB0aGlzLmFjY291bnQucHJpdmF0ZUtleSxcbiAgICAgIHRoaXMuYWNjb3VudC5wdWJsaWNLZXksXG4gICAgICBlbnZlbG9wXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZW5kQWN0aW9uKGVudmVsb3A6IEVudmVsb3ApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICh0aGlzLnNpZ25lciAmJiB0aGlzLnNpZ25lci5zaWduQW5kU2VuZCkge1xuICAgICAgcmV0dXJuIHRoaXMuc2lnbmVyLnNpZ25BbmRTZW5kKGVudmVsb3ApO1xuICAgIH1cblxuICAgIGxldCBzZWxwOiBTZWFsZWRFbnZlbG9wO1xuICAgIGlmICh0aGlzLnNpZ25lciAmJiB0aGlzLnNpZ25lci5zaWduT25seSkge1xuICAgICAgc2VscCA9IGF3YWl0IHRoaXMuc2lnbmVyLnNpZ25Pbmx5KGVudmVsb3ApO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZWxwID0gYXdhaXQgdGhpcy5zaWduQWN0aW9uKGVudmVsb3ApO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuY2xpZW50LnNlbmRBY3Rpb24oe1xuICAgICAgYWN0aW9uOiBzZWxwLmFjdGlvbigpXG4gICAgfSk7XG5cbiAgICByZXR1cm4gc2VscC5oYXNoKCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFRyYW5zZmVyTWV0aG9kIGV4dGVuZHMgQWJzdHJhY3RNZXRob2Qge1xuICBwdWJsaWMgdHJhbnNmZXI6IFRyYW5zZmVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGNsaWVudDogSVJwY01ldGhvZCxcbiAgICBhY2NvdW50OiBBY2NvdW50LFxuICAgIHRyYW5zZmVyOiBUcmFuc2ZlcixcbiAgICBvcHRzPzogQWJzdHJhY3RNZXRob2RPcHRzXG4gICkge1xuICAgIHN1cGVyKGNsaWVudCwgYWNjb3VudCwgb3B0cyk7XG4gICAgdGhpcy50cmFuc2ZlciA9IHRyYW5zZmVyO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGV4ZWN1dGUoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBlbnZlbG9wID0gYXdhaXQgdGhpcy5iYXNlRW52ZWxvcChcbiAgICAgIHRoaXMudHJhbnNmZXIuZ2FzTGltaXQsXG4gICAgICB0aGlzLnRyYW5zZmVyLmdhc1ByaWNlXG4gICAgKTtcbiAgICBlbnZlbG9wLnRyYW5zZmVyID0ge1xuICAgICAgYW1vdW50OiB0aGlzLnRyYW5zZmVyLmFtb3VudCxcbiAgICAgIHJlY2lwaWVudDogdGhpcy50cmFuc2Zlci5yZWNpcGllbnQsXG4gICAgICBwYXlsb2FkOiBCdWZmZXIuZnJvbSh0aGlzLnRyYW5zZmVyLnBheWxvYWQsIFwiaGV4XCIpXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLnNlbmRBY3Rpb24oZW52ZWxvcCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEV4ZWN1dGlvbk1ldGhvZCBleHRlbmRzIEFic3RyYWN0TWV0aG9kIHtcbiAgcHVibGljIGV4ZWN1dGlvbjogRXhlY3V0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGNsaWVudDogSVJwY01ldGhvZCxcbiAgICBhY2NvdW50OiBBY2NvdW50LFxuICAgIGV4ZWN1dGlvbjogRXhlY3V0aW9uLFxuICAgIG9wdHM/OiBBYnN0cmFjdE1ldGhvZE9wdHNcbiAgKSB7XG4gICAgc3VwZXIoY2xpZW50LCBhY2NvdW50LCBvcHRzKTtcbiAgICB0aGlzLmV4ZWN1dGlvbiA9IGV4ZWN1dGlvbjtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBleGVjdXRlKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgZW52ZWxvcCA9IGF3YWl0IHRoaXMuYmFzZUVudmVsb3AoXG4gICAgICB0aGlzLmV4ZWN1dGlvbi5nYXNMaW1pdCxcbiAgICAgIHRoaXMuZXhlY3V0aW9uLmdhc1ByaWNlXG4gICAgKTtcbiAgICBlbnZlbG9wLmV4ZWN1dGlvbiA9IHtcbiAgICAgIGFtb3VudDogdGhpcy5leGVjdXRpb24uYW1vdW50LFxuICAgICAgY29udHJhY3Q6IHRoaXMuZXhlY3V0aW9uLmNvbnRyYWN0LFxuICAgICAgZGF0YTogdGhpcy5leGVjdXRpb24uZGF0YVxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5zZW5kQWN0aW9uKGVudmVsb3ApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHNpZ24oKTogUHJvbWlzZTxJQWN0aW9uPiB7XG4gICAgY29uc3QgZW52ZWxvcCA9IGF3YWl0IHRoaXMuYmFzZUVudmVsb3AoXG4gICAgICB0aGlzLmV4ZWN1dGlvbi5nYXNMaW1pdCxcbiAgICAgIHRoaXMuZXhlY3V0aW9uLmdhc1ByaWNlXG4gICAgKTtcbiAgICBlbnZlbG9wLmV4ZWN1dGlvbiA9IHtcbiAgICAgIGFtb3VudDogdGhpcy5leGVjdXRpb24uYW1vdW50LFxuICAgICAgY29udHJhY3Q6IHRoaXMuZXhlY3V0aW9uLmNvbnRyYWN0LFxuICAgICAgZGF0YTogdGhpcy5leGVjdXRpb24uZGF0YVxuICAgIH07XG5cbiAgICBjb25zdCBzZWxwID0gYXdhaXQgdGhpcy5zaWduQWN0aW9uKGVudmVsb3ApO1xuICAgIHJldHVybiBzZWxwLmFjdGlvbigpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDbGFpbUZyb21SZXdhcmRpbmdGdW5kTWV0aG9kIGV4dGVuZHMgQWJzdHJhY3RNZXRob2Qge1xuICBwdWJsaWMgY2xhaW1Gcm9uUmV3YXJkRnVuZDogQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBjbGllbnQ6IElScGNNZXRob2QsXG4gICAgYWNjb3VudDogQWNjb3VudCxcbiAgICBjbGFpbTogQ2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCxcbiAgICBvcHRzPzogQWJzdHJhY3RNZXRob2RPcHRzXG4gICkge1xuICAgIHN1cGVyKGNsaWVudCwgYWNjb3VudCwgb3B0cyk7XG4gICAgdGhpcy5jbGFpbUZyb25SZXdhcmRGdW5kID0gY2xhaW07XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZXhlY3V0ZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGVudmVsb3AgPSBhd2FpdCB0aGlzLmJhc2VFbnZlbG9wKFxuICAgICAgdGhpcy5jbGFpbUZyb25SZXdhcmRGdW5kLmdhc0xpbWl0LFxuICAgICAgdGhpcy5jbGFpbUZyb25SZXdhcmRGdW5kLmdhc1ByaWNlXG4gICAgKTtcbiAgICBlbnZlbG9wLmNsYWltRnJvbVJld2FyZGluZ0Z1bmQgPSB7XG4gICAgICBhbW91bnQ6IHRoaXMuY2xhaW1Gcm9uUmV3YXJkRnVuZC5hbW91bnQsXG4gICAgICBkYXRhOiB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQuZGF0YVxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5zZW5kQWN0aW9uKGVudmVsb3ApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHNpZ24oKTogUHJvbWlzZTxJQWN0aW9uPiB7XG4gICAgY29uc3QgZW52ZWxvcCA9IGF3YWl0IHRoaXMuYmFzZUVudmVsb3AoXG4gICAgICB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQuZ2FzTGltaXQsXG4gICAgICB0aGlzLmNsYWltRnJvblJld2FyZEZ1bmQuZ2FzUHJpY2VcbiAgICApO1xuICAgIGVudmVsb3AuY2xhaW1Gcm9tUmV3YXJkaW5nRnVuZCA9IHtcbiAgICAgIGFtb3VudDogdGhpcy5jbGFpbUZyb25SZXdhcmRGdW5kLmFtb3VudCxcbiAgICAgIGRhdGE6IHRoaXMuY2xhaW1Gcm9uUmV3YXJkRnVuZC5kYXRhXG4gICAgfTtcblxuICAgIGNvbnN0IHNlbHAgPSBhd2FpdCB0aGlzLnNpZ25BY3Rpb24oZW52ZWxvcCk7XG4gICAgcmV0dXJuIHNlbHAuYWN0aW9uKCk7XG4gIH1cbn1cbiJdfQ==
