"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.encrypt = encrypt;
exports.decrypt = decrypt;
exports.default = void 0;

var _crypto = _interopRequireDefault(require("crypto"));

var _randombytes = _interopRequireDefault(require("randombytes"));

var _scrypt = _interopRequireDefault(require("scrypt.js"));

var _v = _interopRequireDefault(require("uuid/v4"));

var _address = require("../crypto/address");

var _crypto2 = require("../crypto/crypto");

var _hash = require("../crypto/hash");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }
  return obj;
}

function runCipherBuffer(cipher, data) {
  return Buffer.concat([cipher.update(data), cipher.final()]);
}

class Wallet {
  constructor() {
    _defineProperty(this, "accounts", void 0);

    this.accounts = new Map();
  }

  add(account) {
    if (account) {
      this.accounts.set(account.address, account);
    }
  }

  get(address) {
    return this.accounts.get(address);
  }

  remove(address) {
    this.accounts.delete(address);
  }
} // ported from ethereumjs-wallet

exports.default = Wallet;

function encrypt(privateKey, password, opts = {}) {
  const account = (0, _crypto2.privateKeyToAccount)(privateKey);
  const salt = opts.salt || (0, _randombytes.default)(32);
  const iv = opts.iv || (0, _randombytes.default)(16);
  let derivedKey;
  const kdf = opts.kdf || "scrypt";
  const kdfparams = {
    dklen: opts.dklen || 32,
    salt: salt.toString("hex")
  };

  if (kdf === "pbkdf2") {
    kdfparams.c = opts.c || 262144;
    kdfparams.prf = "hmac-sha256";
    derivedKey = _crypto.default.pbkdf2Sync(
      Buffer.from(password),
      salt,
      kdfparams.c,
      kdfparams.dklen,
      "sha256"
    );
  } else if (kdf === "scrypt") {
    // FIXME: support progress reporting callback
    kdfparams.n = opts.n || 262144;
    kdfparams.r = opts.r || 8;
    kdfparams.p = opts.p || 1;
    derivedKey = (0, _scrypt.default)(
      Buffer.from(password),
      salt,
      kdfparams.n,
      kdfparams.r,
      kdfparams.p,
      kdfparams.dklen
    );
  } else {
    throw new Error("Unsupported kdf");
  }

  const cipher = _crypto.default.createCipheriv(
    opts.cipher || "aes-128-ctr",
    derivedKey.slice(0, 16),
    iv
  );

  if (!cipher) {
    throw new Error("Unsupported cipher");
  }

  const ciphertext = runCipherBuffer(cipher, Buffer.from(privateKey, "hex"));
  const mac = (0, _hash.hash256b)(
    Buffer.concat([derivedKey.slice(16, 32), ciphertext])
  );
  return {
    version: 3,
    // @ts-ignore
    id: (0, _v.default)({
      random: opts.uuid || (0, _randombytes.default)(16)
    }),
    address: String(
      (0, _address.fromString)(account.address).stringEth()
    ).replace(/^0x/, ""),
    crypto: {
      ciphertext: ciphertext.toString("hex"),
      cipherparams: {
        iv: iv.toString("hex")
      },
      cipher: opts.cipher || "aes-128-ctr",
      kdf: kdf,
      kdfparams: kdfparams,
      mac: mac.toString("hex")
    }
  };
} // ported from ethereumjs-wallet

function decrypt(privateKey, password) {
  let derivedKey;
  let kdfparams;

  if (privateKey.crypto.kdf === "scrypt") {
    kdfparams = privateKey.crypto.kdfparams; // FIXME: support progress reporting callback

    derivedKey = (0, _scrypt.default)(
      Buffer.from(password),
      Buffer.from(kdfparams.salt, "hex"),
      kdfparams.n,
      kdfparams.r,
      kdfparams.p,
      kdfparams.dklen
    );
  } else if (privateKey.crypto.kdf === "pbkdf2") {
    kdfparams = privateKey.crypto.kdfparams;

    if (kdfparams.prf !== "hmac-sha256") {
      throw new Error("Unsupported parameters to PBKDF2");
    }

    derivedKey = _crypto.default.pbkdf2Sync(
      Buffer.from(password),
      Buffer.from(kdfparams.salt, "hex"),
      kdfparams.c || 0,
      kdfparams.dklen,
      "sha256"
    );
  } else {
    throw new Error("Unsupported key derivation scheme");
  }

  const ciphertext = Buffer.from(privateKey.crypto.ciphertext, "hex");
  const mac = (0, _hash.hash256b)(
    Buffer.concat([derivedKey.slice(16, 32), ciphertext])
  );

  if (mac.toString("hex") !== privateKey.crypto.mac) {
    throw new Error("Key derivation failed - possibly wrong passphrase");
  }

  const decipher = _crypto.default.createDecipheriv(
    privateKey.crypto.cipher,
    derivedKey.slice(0, 16),
    Buffer.from(privateKey.crypto.cipherparams.iv, "hex")
  );

  const seed = runCipherBuffer(decipher, ciphertext);
  return (0, _crypto2.privateKeyToAccount)(seed.toString("hex"));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY2NvdW50L3dhbGxldC50cyJdLCJuYW1lcyI6WyJydW5DaXBoZXJCdWZmZXIiLCJjaXBoZXIiLCJkYXRhIiwiQnVmZmVyIiwiY29uY2F0IiwidXBkYXRlIiwiZmluYWwiLCJXYWxsZXQiLCJjb25zdHJ1Y3RvciIsImFjY291bnRzIiwiTWFwIiwiYWRkIiwiYWNjb3VudCIsInNldCIsImFkZHJlc3MiLCJnZXQiLCJyZW1vdmUiLCJkZWxldGUiLCJlbmNyeXB0IiwicHJpdmF0ZUtleSIsInBhc3N3b3JkIiwib3B0cyIsInNhbHQiLCJpdiIsImRlcml2ZWRLZXkiLCJrZGYiLCJrZGZwYXJhbXMiLCJka2xlbiIsInRvU3RyaW5nIiwiYyIsInByZiIsImNyeXB0byIsInBia2RmMlN5bmMiLCJmcm9tIiwibiIsInIiLCJwIiwiRXJyb3IiLCJjcmVhdGVDaXBoZXJpdiIsInNsaWNlIiwiY2lwaGVydGV4dCIsIm1hYyIsInZlcnNpb24iLCJpZCIsInJhbmRvbSIsInV1aWQiLCJTdHJpbmciLCJzdHJpbmdFdGgiLCJyZXBsYWNlIiwiY2lwaGVycGFyYW1zIiwiZGVjcnlwdCIsImRlY2lwaGVyIiwiY3JlYXRlRGVjaXBoZXJpdiIsInNlZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFpQ0EsU0FBU0EsZUFBVCxDQUNFQyxNQURGLEVBRUVDLElBRkYsRUFHVTtBQUNSLFNBQU9DLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLENBQUNILE1BQU0sQ0FBQ0ksTUFBUCxDQUFjSCxJQUFkLENBQUQsRUFBc0JELE1BQU0sQ0FBQ0ssS0FBUCxFQUF0QixDQUFkLENBQVA7QUFDRDs7QUFlYyxNQUFNQyxNQUFOLENBQWE7QUFHMUJDLEVBQUFBLFdBQVcsR0FBRztBQUFBOztBQUNaLFNBQUtDLFFBQUwsR0FBZ0IsSUFBSUMsR0FBSixFQUFoQjtBQUNEOztBQUVNQyxFQUFBQSxHQUFQLENB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akIsRUFBcUIsRUFBckIsQ0FBRCxFQUEyQkMsVUFBM0IsQ0FBZCxDQUFULENBQVo7O0FBQ0EsTUFBSUMsR0FBRyxDQUFDYixRQUFKLENBQWEsS0FBYixNQUF3QlQsVUFBVSxDQUFDWSxNQUFYLENBQWtCVSxHQUE5QyxFQUFtRDtBQUNqRCxVQUFNLElBQUlKLEtBQUosQ0FBVSxtREFBVixDQUFOO0FBQ0Q7O0FBRUQsUUFBTWMsUUFBUSxHQUFHcEIsZ0JBQU9xQixnQkFBUCxDQUNmakMsVUFBVSxDQUFDWSxNQUFYLENBQWtCOUIsTUFESCxFQUVmdUIsVUFBVSxDQUFDZSxLQUFYLENBQWlCLENBQWpCLEVBQW9CLEVBQXBCLENBRmUsRUFHZnBDLE1BQU0sQ0FBQzhCLElBQVAsQ0FBWWQsVUFBVSxDQUFDWSxNQUFYLENBQWtCa0IsWUFBbEIsQ0FBK0IxQixFQUEzQyxFQUErQyxLQUEvQyxDQUhlLENBQWpCOztBQUtBLFFBQU04QixJQUFJLEdBQUdyRCxlQUFlLENBQUNtRCxRQUFELEVBQVdYLFVBQVgsQ0FBNUI7QUFFQSxTQUFPLGtDQUFvQmEsSUFBSSxDQUFDekIsUUFBTCxDQUFjLEtBQWQsQ0FBcEIsQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNyeXB0bywgeyBDaXBoZXIsIERlY2lwaGVyIH0gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IHJhbmRvbUJ5dGVzIGZyb20gXCJyYW5kb21ieXRlc1wiO1xuLy8gQHRzLWlnbm9yZVxuaW1wb3J0IHNjcnlwdHN5IGZyb20gXCJzY3J5cHQuanNcIjtcbmltcG9ydCB1dWlkdjQgZnJvbSBcInV1aWQvdjRcIjtcbmltcG9ydCB7IGZyb21TdHJpbmcgfSBmcm9tIFwiLi4vY3J5cHRvL2FkZHJlc3NcIjtcbmltcG9ydCB7IHByaXZhdGVLZXlUb0FjY291bnQgfSBmcm9tIFwiLi4vY3J5cHRvL2NyeXB0b1wiO1xuaW1wb3J0IHsgaGFzaDI1NmIgfSBmcm9tIFwiLi4vY3J5cHRvL2hhc2hcIjtcbmltcG9ydCB7IElBY2NvdW50IH0gZnJvbSBcIi4vYWNjb3VudFwiO1xuXG50eXBlIEtkZnBhcmFtcyA9IHtcbiAgZGtsZW46IG51bWJlcjtcbiAgc2FsdDogc3RyaW5nO1xuXG4gIC8vIHNjcnlwdFxuICBuPzogbnVtYmVyO1xuICBwPzogbnVtYmVyO1xuICByPzogbnVtYmVyO1xuXG4gIC8vIHBia2RmMlxuICBjPzogbnVtYmVyO1xuICBwcmY/OiBzdHJpbmc7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIFByaXZhdGVLZXkge1xuICBhZGRyZXNzOiBzdHJpbmc7XG4gIGNyeXB0bzoge1xuICAgIGNpcGhlcjogc3RyaW5nO1xuICAgIGNpcGhlcnRleHQ6IHN0cmluZztcbiAgICBjaXBoZXJwYXJhbXM6IHtcbiAgICAgIGl2OiBzdHJpbmc7XG4gICAgfTtcbiAgICBrZGY6IHN0cmluZztcbiAgICBrZGZwYXJhbXM6IEtkZnBhcmFtcztcbiAgICBtYWM6IHN0cmluZztcbiAgfTtcbiAgaWQ6IHN0cmluZztcbiAgdmVyc2lvbjogbnVtYmVyO1xufVxuXG5mdW5jdGlvbiBydW5DaXBoZXJCdWZmZXIoXG4gIGNpcGhlcjogQ2lwaGVyIHwgRGVjaXBoZXIsXG4gIGRhdGE6IGNyeXB0by5CaW5hcnlcbik6IEJ1ZmZlciB7XG4gIHJldHVybiBCdWZmZXIuY29uY2F0KFtjaXBoZXIudXBkYXRlKGRhdGEpLCBjaXBoZXIuZmluYWwoKV0pO1xufVxuXG50eXBlIEVuY3J5cHRPcHRpb25zID0ge1xuICBjaXBoZXI/OiBzdHJpbmc7XG4gIHNhbHQ/OiBzdHJpbmc7XG4gIGRrbGVuPzogbnVtYmVyO1xuICBpdj86IHN0cmluZztcbiAga2RmPzogc3RyaW5nO1xuICBjPzogbnVtYmVyO1xuICBuPzogbnVtYmVyO1xuICByPzogbnVtYmVyO1xuICBwPzogbnVtYmVyO1xuICB1dWlkPzogc3RyaW5nO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2FsbGV0IHtcbiAgcHJpdmF0ZSByZWFkb25seSBhY2NvdW50czogTWFwPHN0cmluZywgSUFjY291bnQ+O1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuYWNjb3VudHMgPSBuZXcgTWFwKCk7XG4gIH1cblxuICBwdWJsaWMgYWRkKGFjY291bnQ6IElBY2NvdW50KTogdm9pZCB7XG4gICAgaWYgKGFjY291bnQpIHtcbiAgICAgIHRoaXMuYWNjb3VudHMuc2V0KGFjY291bnQuYWRkcmVzcywgYWNjb3VudCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldChhZGRyZXNzOiBzdHJpbmcpOiBJQWNjb3VudCB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuYWNjb3VudHMuZ2V0KGFkZHJlc3MpO1xuICB9XG5cbiAgcHVibGljIHJlbW92ZShhZGRyZXNzOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmFjY291bnRzLmRlbGV0ZShhZGRyZXNzKTtcbiAgfVxufVxuXG4vLyBwb3J0ZWQgZnJvbSBldGhlcmV1bWpzLXdhbGxldFxuZXhwb3J0IGZ1bmN0aW9uIGVuY3J5cHQoXG4gIHByaXZhdGVLZXk6IHN0cmluZyxcbiAgcGFzc3dvcmQ6IHN0cmluZyxcbiAgb3B0czogRW5jcnlwdE9wdGlvbnMgPSB7fVxuKTogUHJpdmF0ZUtleSB7XG4gIGNvbnN0IGFjY291bnQgPSBwcml2YXRlS2V5VG9BY2NvdW50KHByaXZhdGVLZXkpO1xuXG4gIGNvbnN0IHNhbHQgPSBvcHRzLnNhbHQgfHwgcmFuZG9tQnl0ZXMoMzIpO1xuICBjb25zdCBpdiA9IG9wdHMuaXYgfHwgcmFuZG9tQnl0ZXMoMTYpO1xuXG4gIGxldCBkZXJpdmVkS2V5O1xuICBjb25zdCBrZGYgPSBvcHRzLmtkZiB8fCBcInNjcnlwdFwiO1xuICBjb25zdCBrZGZwYXJhbXM6IEtkZnBhcmFtcyA9IHtcbiAgICBka2xlbjogb3B0cy5ka2xlbiB8fCAzMixcbiAgICBzYWx0OiBzYWx0LnRvU3RyaW5nKFwiaGV4XCIpXG4gIH07XG5cbiAgaWYgKGtkZiA9PT0gXCJwYmtkZjJcIikge1xuICAgIGtkZnBhcmFtcy5jID0gb3B0cy5jIHx8IDI2MjE0NDtcbiAgICBrZGZwYXJhbXMucHJmID0gXCJobWFjLXNoYTI1NlwiO1xuICAgIGRlcml2ZWRLZXkgPSBjcnlwdG8ucGJrZGYyU3luYyhcbiAgICAgIEJ1ZmZlci5mcm9tKHBhc3N3b3JkKSxcbiAgICAgIHNhbHQsXG4gICAgICBrZGZwYXJhbXMuYyxcbiAgICAgIGtkZnBhcmFtcy5ka2xlbixcbiAgICAgIFwic2hhMjU2XCJcbiAgICApO1xuICB9IGVsc2UgaWYgKGtkZiA9PT0gXCJzY3J5cHRcIikge1xuICAgIC8vIEZJWE1FOiBzdXBwb3J0IHByb2dyZXNzIHJlcG9ydGluZyBjYWxsYmFja1xuICAgIGtkZnBhcmFtcy5uID0gb3B0cy5uIHx8IDI2MjE0NDtcbiAgICBrZGZwYXJhbXMuciA9IG9wdHMuciB8fCA4O1xuICAgIGtkZnBhcmFtcy5wID0gb3B0cy5wIHx8IDE7XG4gICAgZGVyaXZlZEtleSA9IHNjcnlwdHN5KFxuICAgICAgQnVmZmVyLmZyb20ocGFzc3dvcmQpLFxuICAgICAgc2FsdCxcbiAgICAgIGtkZnBhcmFtcy5uLFxuICAgICAga2RmcGFyYW1zLnIsXG4gICAgICBrZGZwYXJhbXMucCxcbiAgICAgIGtkZnBhcmFtcy5ka2xlblxuICAgICk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVW5zdXBwb3J0ZWQga2RmXCIpO1xuICB9XG5cbiAgY29uc3QgY2lwaGVyID0gY3J5cHRvLmNyZWF0ZUNpcGhlcml2KFxuICAgIG9wdHMuY2lwaGVyIHx8IFwiYWVzLTEyOC1jdHJcIixcbiAgICBkZXJpdmVkS2V5LnNsaWNlKDAsIDE2KSxcbiAgICBpdlxuICApO1xuICBpZiAoIWNpcGhlcikge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlVuc3VwcG9ydGVkIGNpcGhlclwiKTtcbiAgfVxuXG4gIGNvbnN0IGNpcGhlcnRleHQgPSBydW5DaXBoZXJCdWZmZXIoY2lwaGVyLCBCdWZmZXIuZnJvbShwcml2YXRlS2V5LCBcImhleFwiKSk7XG5cbiAgY29uc3QgbWFjID0gaGFzaDI1NmIoQnVmZmVyLmNvbmNhdChbZGVyaXZlZEtleS5zbGljZSgxNiwgMzIpLCBjaXBoZXJ0ZXh0XSkpO1xuXG4gIHJldHVybiB7XG4gICAgdmVyc2lvbjogMyxcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgaWQ6IHV1aWR2NCh7IHJhbmRvbTogb3B0cy51dWlkIHx8IHJhbmRvbUJ5dGVzKDE2KSB9KSxcbiAgICBhZGRyZXNzOiBTdHJpbmcoZnJvbVN0cmluZyhhY2NvdW50LmFkZHJlc3MpLnN0cmluZ0V0aCgpKS5yZXBsYWNlKC9eMHgvLCBcIlwiKSxcbiAgICBjcnlwdG86IHtcbiAgICAgIGNpcGhlcnRleHQ6IGNpcGhlcnRleHQudG9TdHJpbmcoXCJoZXhcIiksXG4gICAgICBjaXBoZXJwYXJhbXM6IHtcbiAgICAgICAgaXY6IGl2LnRvU3RyaW5nKFwiaGV4XCIpXG4gICAgICB9LFxuICAgICAgY2lwaGVyOiBvcHRzLmNpcGhlciB8fCBcImFlcy0xMjgtY3RyXCIsXG4gICAgICBrZGY6IGtkZixcbiAgICAgIGtkZnBhcmFtczoga2RmcGFyYW1zLFxuICAgICAgbWFjOiBtYWMudG9TdHJpbmcoXCJoZXhcIilcbiAgICB9XG4gIH07XG59XG5cbi8vIHBvcnRlZCBmcm9tIGV0aGVyZXVtanMtd2FsbGV0XG5leHBvcnQgZnVuY3Rpb24gZGVjcnlwdChcbiAgcHJpdmF0ZUtleTogUHJpdmF0ZUtleSxcbiAgcGFzc3dvcmQ6IHN0cmluZ1xuKTogeyBhZGRyZXNzOiBzdHJpbmc7IHB1YmxpY0tleTogc3RyaW5nOyBwcml2YXRlS2V5OiBzdHJpbmcgfSB7XG4gIGxldCBkZXJpdmVkS2V5O1xuICBsZXQga2RmcGFyYW1zO1xuICBpZiAocHJpdmF0ZUtleS5jcnlwdG8ua2RmID09PSBcInNjcnlwdFwiKSB7XG4gICAga2RmcGFyYW1zID0gcHJpdmF0ZUtleS5jcnlwdG8ua2RmcGFyYW1zO1xuXG4gICAgLy8gRklYTUU6IHN1cHBvcnQgcHJvZ3Jlc3MgcmVwb3J0aW5nIGNhbGxiYWNrXG4gICAgZGVyaXZlZEtleSA9IHNjcnlwdHN5KFxuICAgICAgQnVmZmVyLmZyb20ocGFzc3dvcmQpLFxuICAgICAgQnVmZmVyLmZyb20oa2RmcGFyYW1zLnNhbHQsIFwiaGV4XCIpLFxuICAgICAga2RmcGFyYW1zLm4sXG4gICAgICBrZGZwYXJhbXMucixcbiAgICAgIGtkZnBhcmFtcy5wLFxuICAgICAga2RmcGFyYW1zLmRrbGVuXG4gICAgKTtcbiAgfSBlbHNlIGlmIChwcml2YXRlS2V5LmNyeXB0by5rZGYgPT09IFwicGJrZGYyXCIpIHtcbiAgICBrZGZwYXJhbXMgPSBwcml2YXRlS2V5LmNyeXB0by5rZGZwYXJhbXM7XG5cbiAgICBpZiAoa2RmcGFyYW1zLnByZiAhPT0gXCJobWFjLXNoYTI1NlwiKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZCBwYXJhbWV0ZXJzIHRvIFBCS0RGMlwiKTtcbiAgICB9XG5cbiAgICBkZXJpdmVkS2V5ID0gY3J5cHRvLnBia2RmMlN5bmMoXG4gICAgICBCdWZmZXIuZnJvbShwYXNzd29yZCksXG4gICAgICBCdWZmZXIuZnJvbShrZGZwYXJhbXMuc2FsdCwgXCJoZXhcIiksXG4gICAgICBrZGZwYXJhbXMuYyB8fCAwLFxuICAgICAga2RmcGFyYW1zLmRrbGVuLFxuICAgICAgXCJzaGEyNTZcIlxuICAgICk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVW5zdXBwb3J0ZWQga2V5IGRlcml2YXRpb24gc2NoZW1lXCIpO1xuICB9XG5cbiAgY29uc3QgY2lwaGVydGV4dCA9IEJ1ZmZlci5mcm9tKHByaXZhdGVLZXkuY3J5cHRvLmNpcGhlcnRleHQsIFwiaGV4XCIpO1xuXG4gIGNvbnN0IG1hYyA9IGhhc2gyNTZiKEJ1ZmZlci5jb25jYXQoW2Rlcml2ZWRLZXkuc2xpY2UoMTYsIDMyKSwgY2lwaGVydGV4dF0pKTtcbiAgaWYgKG1hYy50b1N0cmluZyhcImhleFwiKSAhPT0gcHJpdmF0ZUtleS5jcnlwdG8ubWFjKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiS2V5IGRlcml2YXRpb24gZmFpbGVkIC0gcG9zc2libHkgd3JvbmcgcGFzc3BocmFzZVwiKTtcbiAgfVxuXG4gIGNvbnN0IGRlY2lwaGVyID0gY3J5cHRvLmNyZWF0ZURlY2lwaGVyaXYoXG4gICAgcHJpdmF0ZUtleS5jcnlwdG8uY2lwaGVyLFxuICAgIGRlcml2ZWRLZXkuc2xpY2UoMCwgMTYpLFxuICAgIEJ1ZmZlci5mcm9tKHByaXZhdGVLZXkuY3J5cHRvLmNpcGhlcnBhcmFtcy5pdiwgXCJoZXhcIilcbiAgKTtcbiAgY29uc3Qgc2VlZCA9IHJ1bkNpcGhlckJ1ZmZlcihkZWNpcGhlciwgY2lwaGVydGV4dCk7XG5cbiAgcmV0dXJuIHByaXZhdGVLZXlUb0FjY291bnQoc2VlZC50b1N0cmluZyhcImhleFwiKSk7XG59XG4iXX0=
